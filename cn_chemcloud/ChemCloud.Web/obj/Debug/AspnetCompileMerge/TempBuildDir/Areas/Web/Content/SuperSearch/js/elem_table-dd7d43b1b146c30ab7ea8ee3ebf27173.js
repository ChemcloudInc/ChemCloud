/****************************************************************************
 * Copyright (C) 2009-2010 GGA Software Services LLC
 *
 * This file may be distributed and/or modified under the terms of the
 * GNU Affero General Public License version 3 as published by the Free
 * Software Foundation and appearing in the file LICENSE.GPL included in
 * the packaging of this file.
 *
 * This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE
 * WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.
 ***************************************************************************/
if(!window.Prototype)throw new Error("Prototype.js should be loaded first");if(!window.rnd)throw new Error("rnd should be defined prior to loading this file");rnd.ElementTable=function(e,t,n){t=t||{},e=$(e),e.innerHTML="";var r=this;this.onClick=t.onClick||function(e){this.mode=="single"?r.setElementSingle(e):r.setElementSelected(e,!r.items[e].selected),r.updateAtomProps()};var i=t.buttonHalfSize||16;this.elemHalfSz=new util.Vec2(i,i),this.elemSz=this.elemHalfSz.scaled(2),this.spacing=new util.Vec2(3,3),this.cornerRadius=0,this.orig=this.elemSz.scaled(0),this.mode="single",n&&(this.size=new util.Vec2((this.elemSz.x+this.spacing.x)*18+this.spacing.x,(this.elemSz.y+this.spacing.y)*9+this.spacing.y),e.style.width=this.size.x.toString()+"px",e.style.height=this.size.y.toString()+"px"),this.viewSz=new util.Vec2(e.clientWidth||100,e.clientHeight||100),this.paper=new Raphael(e,this.viewSz.x,this.viewSz.y),this.bb=new util.Box2Abs(new util.Vec2,this.viewSz),this.fillColor=t.fillColor||"#def",this.fillColorSelected=t.fillColorSelected||"#fcb",this.frameColor=t.frameColor||"#9ad",this.frameThickness=t.frameThickness||"1pt",this.fontSize=t.fontSize||19,this.fontType=t.fontType||"Arial",this.frameAttrs={fill:this.fillColor,stroke:this.frameColor,"stroke-width":this.frameThickness},this.fontAttrs={"font-family":this.fontType,"font-size":this.fontSize},this.items={},this.selectedLabels=util.Set.empty(),this.singleLabel=-1,this.atomProps={}},rnd.ElementTable.prototype.updateAtomProps=function(){this.atomProps={};if(this.mode=="single"){if(this.singleLabel<0)return;this.atomProps.label=chem.Element.elements.get(this.singleLabel).label}else{if(util.Set.size(this.selectedLabels)==0)return;var e=this.mode=="notlist",t=util.Set.list(this.selectedLabels);t.sort(function(e,t){return e-t}),this.atomProps={label:"",atomList:new chem.Struct.AtomList({notList:e,ids:t})}}},rnd.ElementTable.prototype.getAtomProps=function(){return this.atomProps},rnd.ElementTable.prototype.renderTable=function(){var e=this;chem.Element.elements.each(function(t,n){var r=new util.Vec2(this.orig.x+(n.xpos-1)*(this.spacing.x+this.elemSz.x)+this.elemHalfSz.x+this.spacing.x,this.orig.y+(n.ypos-1)*(this.spacing.y+this.elemSz.y)+this.elemHalfSz.y+this.spacing.y),i=this.paper.rect(r.x-this.elemHalfSz.x,r.y-this.elemHalfSz.y,this.elemSz.x,this.elemSz.y,this.cornerRadius).attr(this.frameAttrs),s=this.paper.text(r.x,r.y,n.label).attr(this.fontAttrs).attr("fill",n.labelColor);i.node.onclick=function(){e.onClick(t)},s.node.onclick=function(){e.onClick(t)},this.items[t]={box:i,label:s,selected:!1}},this)},rnd.ElementTable.prototype.renderSingle=function(e){var t=chem.Element.getElementByLabel(e),n=chem.Element.elements.get(t);this.items[e]=this.paper.text(this.viewSz.x/2,this.viewSz.y/2,e).attr(this.fontAttrs).attr("fill",n?n.color:"#000")},rnd.ElementTable.prototype.renderArrow=function(){var e=4,t=16,n=6,r=4;this.items.arrow=this.paper.path("M{1},{3}L{2},{4}L{1},{5}M{0},{4}L{2},{4}",e,2*t-n-e,2*t-e,t-r,t,t+r).attr({stroke:"#000","stroke-width":"2px"})},rnd.ElementTable.prototype.renderPlus=function(){var e=16,t=9;this.items.plus=this.paper.path("M{1},{0}L{1},{2}M{0},{1}L{2},{1}",e-t,e,e+t).attr({stroke:"#000","stroke-width":"2px"})},rnd.ElementTable.prototype.markSelected=function(e,t){var n=this.items[e];t?n.box.attr("fill",this.fillColorSelected):n.box.attr("fill",this.fillColor),n.selected=t},rnd.ElementTable.prototype.setElementSingle=function(e){this.singleLabel>=0&&this.markSelected(this.singleLabel,!1),e>=0&&this.markSelected(e,!0),this.singleLabel=e},rnd.ElementTable.prototype.setElementSelected=function(e,t){this.markSelected(e,t),t?util.Set.add(this.selectedLabels,e):util.Set.remove(this.selectedLabels,e)},rnd.ElementTable.prototype.setMode=function(e){e=="single"?(util.Set.each(this.selectedLabels,function(e){this.markSelected(e,!1)},this),this.selectedLabels=util.Set.empty()):this.setElementSingle(-1),this.mode=e,this.updateAtomProps()},rnd.ElementTable.prototype.store=function(){this.old={selectedLabels:util.Set.clone(this.selectedLabels),singleLabel:this.singleLabel,mode:this.mode}},rnd.ElementTable.prototype.restore=function(){util.Set.each(this.selectedLabels,function(e){this.markSelected(e,!1)},this),this.singleLabel>=0&&this.markSelected(this.singleLabel,!1),this.setMode(this.old.mode),this.old.mode=="single"?this.setElementSingle(this.old.singleLabel):(util.Set.each(this.old.selectedLabels,function(e){this.markSelected(e,!0)},this),this.selectedLabels=util.Set.clone(this.old.selectedLabels)),$("elem_table_"+this.old.mode).checked=!0,this.updateAtomProps()};