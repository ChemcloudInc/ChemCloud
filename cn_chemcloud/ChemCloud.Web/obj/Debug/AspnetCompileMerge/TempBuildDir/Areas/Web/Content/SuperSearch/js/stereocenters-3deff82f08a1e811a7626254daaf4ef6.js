/****************************************************************************
 * Copyright (C) 2009-2010 GGA Software Services LLC
 * 
 * This file may be distributed and/or modified under the terms of the
 * GNU Affero General Public License version 3 as published by the Free
 * Software Foundation and appearing in the file LICENSE.GPL included in
 * the packaging of this file.
 * 
 * This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE
 * WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.
 ***************************************************************************/
if(!window.chem||!chem.Struct)throw new Error("Vec2 and Molecule should be defined first");chem.Stereocenters=function(e,t,n){this.molecule=e,this.atoms=new util.Map,this.getNeighbors=t,this.context=n},chem.Stereocenters.prototype.each=function(e,t){this.atoms.each(e,t)},chem.Stereocenters.prototype.buildFromBonds=function(e){this.molecule.atoms.each(function(t){var n=this.getNeighbors.call(this.context,t),r=!1;n.find(function(e){var n=this.molecule.bonds.get(e.bid);if(n.type==chem.Struct.BOND.TYPE.SINGLE&&n.begin==t)if(n.stereo==chem.Struct.BOND.STEREO.UP||n.stereo==chem.Struct.BOND.STEREO.DOWN)return r=!0,!0;return!1},this);if(!r)return;e?this._buildOneCenter(t):this._buildOneCenter(t)},this)},chem.Stereocenters.allowed_stereocenters=[{elem:"C",charge:0,degree:3,n_double_bonds:0,implicit_degree:4},{elem:"C",charge:0,degree:4,n_double_bonds:0,implicit_degree:4},{elem:"Si",charge:0,degree:3,n_double_bonds:0,implicit_degree:4},{elem:"Si",charge:0,degree:4,n_double_bonds:0,implicit_degree:4},{elem:"N",charge:1,degree:3,n_double_bonds:0,implicit_degree:4},{elem:"N",charge:1,degree:4,n_double_bonds:0,implicit_degree:4},{elem:"N",charge:0,degree:3,n_double_bonds:0,implicit_degree:3},{elem:"S",charge:0,degree:4,n_double_bonds:2,implicit_degree:4},{elem:"S",charge:1,degree:3,n_double_bonds:0,implicit_degree:3},{elem:"S",charge:0,degree:3,n_double_bonds:1,implicit_degree:3},{elem:"P",charge:0,degree:3,n_double_bonds:0,implicit_degree:3},{elem:"P",charge:1,degree:4,n_double_bonds:0,implicit_degree:4},{elem:"P",charge:0,degree:4,n_double_bonds:1,implicit_degree:4}],chem.Stereocenters.prototype._buildOneCenter=function(e){var t=this.molecule.atoms.get(e),n=this.getNeighbors.call(this.context,e),r=n.length,i=-1,s={group:0,type:0,pyramid:new Array(4)},o=0,u=new Array(4),a=0,f=0;s.pyramid[0]=-1,s.pyramid[1]=-1,s.pyramid[2]=-1,s.pyramid[3]=-1;var l=0;if(r>4)throw new Error("stereocenter with %d bonds are not supported"+r);n.each(function(e){var n=this.molecule.atoms.get(e.aid),r=this.molecule.bonds.get(e.bid);u[o]={edge_idx:e.bid,nei_idx:e.aid,rank:e.aid,vec:util.Vec2.diff(n.pp,t.pp)},n.pureHydrogen()?(l++,u[o].rank=1e4):n.label=="H"&&(u[o].rank=5e3);if(!u[o].vec.normalize())throw new Error("zero bond length");if(r.type==chem.Struct.BOND.TYPE.TRIPLE)throw new Error("non-single bonds not allowed near stereocenter");if(r.type==chem.Struct.BOND.TYPE.AROMATIC)throw new Error("aromatic bonds not allowed near stereocenter");r.type==chem.Struct.BOND.TYPE.DOUBLE&&f++,o++},this),chem.Stereocenters.allowed_stereocenters.find(function(e){return e.elem==t.label&&e.charge==t.charge&&e.degree==r&&e.n_double_bonds==f?(i=e.implicit_degree,!0):!1},this);if(i==-1)throw new Error("unknown stereocenter configuration: "+t.label+", charge "+t.charge+", "+r+" bonds ("+f+" double)");if(r==4&&l>1)throw new Error(l+" hydrogens near stereocenter");if(r==3&&i==4&&l>0)throw new Error("have hydrogen(s) besides implicit hydrogen near stereocenter");if(r==4){u[0].rank>u[1].rank&&u.swap(0,1),u[1].rank>u[2].rank&&u.swap(1,2),u[2].rank>u[3].rank&&u.swap(2,3),u[1].rank>u[2].rank&&u.swap(1,2),u[0].rank>u[1].rank&&u.swap(0,1),u[1].rank>u[2].rank&&u.swap(1,2);var c=-1,h=-1,p=-1,d=-1,v=0;for(o=0;o<4;o++){var m=this._getBondStereo(e,u[o].edge_idx);if(m==chem.Struct.BOND.STEREO.UP||m==chem.Struct.BOND.STEREO.DOWN){c=o,v=m;break}}if(c==-1)throw new Error("none of 4 bonds going from stereocenter is stereobond");var g,y;if(h==-1){g=chem.Stereocenters._xyzzy(u[c].vec,u[(c+1)%4].vec,u[(c+2)%4].vec),y=chem.Stereocenters._xyzzy(u[c].vec,u[(c+1)%4].vec,u[(c+3)%4].vec);if(g+y==3||g+y==12)h=(c+1)%4,p=(c+2)%4,d=(c+3)%4}if(h==-1){g=chem.Stereocenters._xyzzy(u[c].vec,u[(c+2)%4].vec,u[(c+1)%4].vec),y=chem.Stereocenters._xyzzy(u[c].vec,u[(c+2)%4].vec,u[(c+3)%4].vec);if(g+y==3||g+y==12)h=(c+2)%4,p=(c+1)%4,d=(c+3)%4}if(h==-1){g=chem.Stereocenters._xyzzy(u[c].vec,u[(c+3)%4].vec,u[(c+1)%4].vec),y=chem.Stereocenters._xyzzy(u[c].vec,u[(c+3)%4].vec,u[(c+2)%4].vec);if(g+y==3||g+y==12)h=(c+3)%4,p=(c+2)%4,d=(c+1)%4}if(h==-1)throw new Error("internal error: can not find opposite bond");if(v==chem.Struct.BOND.STEREO.UP&&this._getBondStereo(e,u[h].edge_idx)==chem.Struct.BOND.STEREO.DOWN)throw new Error("stereo types of the opposite bonds mismatch");if(v==chem.Struct.BOND.STEREO.DOWN&&this._getBondStereo(e,u[h].edge_idx)==chem.Struct.BOND.STEREO.UP)throw new Error("stereo types of the opposite bonds mismatch");if(v==this._getBondStereo(e,u[p].edge_idx))throw new Error("stereo types of non-opposite bonds match");if(v==this._getBondStereo(e,u[d].edge_idx))throw new Error("stereo types of non-opposite bonds match");c==3||h==3?a=v:a=v==chem.Struct.BOND.STEREO.UP?chem.Struct.BOND.STEREO.DOWN:chem.Struct.BOND.STEREO.UP,N=chem.Stereocenters._sign(u[0].vec,u[1].vec,u[2].vec),a==chem.Struct.BOND.STEREO.UP&&N>0||a==chem.Struct.BOND.STEREO.DOWN&&N<0?(s.pyramid[0]=u[0].nei_idx,s.pyramid[1]=u[1].nei_idx,s.pyramid[2]=u[2].nei_idx):(s.pyramid[0]=u[0].nei_idx,s.pyramid[1]=u[2].nei_idx,s.pyramid[2]=u[1].nei_idx),s.pyramid[3]=u[3].nei_idx}else if(r==3){u[0].rank>u[1].rank&&u.swap(0,1),u[1].rank>u[2].rank&&u.swap(1,2),u[0].rank>u[1].rank&&u.swap(0,1);var b=this._getBondStereo(e,u[0].edge_idx),w=this._getBondStereo(e,u[1].edge_idx),E=this._getBondStereo(e,u[2].edge_idx),S=0,x=0;S+=b==chem.Struct.BOND.STEREO.UP?1:0,S+=w==chem.Struct.BOND.STEREO.UP?1:0,S+=E==chem.Struct.BOND.STEREO.UP?1:0,x+=b==chem.Struct.BOND.STEREO.DOWN?1:0,x+=w==chem.Struct.BOND.STEREO.DOWN?1:0,x+=E==chem.Struct.BOND.STEREO.DOWN?1:0;if(i==4){if(S==3)throw new Error("all 3 bonds up near stereoatom");if(x==3)throw new Error("all 3 bonds down near stereoatom");if(S==0&&x==0)throw new Error("no up/down bonds near stereoatom -- indefinite case");if(S==1&&x==1)throw new Error("one bond up, one bond down -- indefinite case");v=0;if(S==2)a=chem.Struct.BOND.STEREO.DOWN;else if(x==2)a=chem.Struct.BOND.STEREO.UP;else{c=-1,p=-1,d=-1;for(o=0;o<3;o++){C=this._getBondStereo(e,u[o].edge_idx);if(C==chem.Struct.BOND.STEREO.UP||C==chem.Struct.BOND.STEREO.DOWN){c=o,v=C,p=(o+1)%3,d=(o+2)%3;break}}if(c==-1)throw new Error("internal error: can not find up or down bond");var T=chem.Stereocenters._xyzzy(u[p].vec,u[d].vec,u[c].vec);if(T==3||T==4)throw new Error("degenerate case for 3 bonds near stereoatom");T==1?a=v:a=v==chem.Struct.BOND.STEREO.UP?chem.Struct.BOND.STEREO.DOWN:chem.Struct.BOND.STEREO.UP}var N=chem.Stereocenters._sign(u[0].vec,u[1].vec,u[2].vec);a==chem.Struct.BOND.STEREO.UP&&N>0||a==chem.Struct.BOND.STEREO.DOWN&&N<0?(s.pyramid[0]=u[0].nei_idx,s.pyramid[1]=u[1].nei_idx,s.pyramid[2]=u[2].nei_idx):(s.pyramid[0]=u[0].nei_idx,s.pyramid[1]=u[2].nei_idx,s.pyramid[2]=u[1].nei_idx),s.pyramid[3]=-1}else{var C;if(x>0&&S>0)throw new Error("one bond up, one bond down -- indefinite case");if(x==0&&S==0)throw new Error("no up-down bonds attached to stereocenter");S>0?C=1:C=-1;if(chem.Stereocenters._xyzzy(u[0].vec,u[1].vec,u[2].vec)==1||chem.Stereocenters._xyzzy(u[0].vec,u[2].vec,u[1].vec)==1||chem.Stereocenters._xyzzy(u[2].vec,u[1].vec,u[0].vec)==1)C=-C;N=chem.Stereocenters._sign(u[0].vec,u[1].vec,u[2].vec),N==C?(s.pyramid[0]=u[0].nei_idx,s.pyramid[1]=u[2].nei_idx,s.pyramid[2]=u[1].nei_idx):(s.pyramid[0]=u[0].nei_idx,s.pyramid[1]=u[1].nei_idx,s.pyramid[2]=u[2].nei_idx),s.pyramid[3]=-1}}this.atoms.set(e,s)},chem.Stereocenters.prototype._getBondStereo=function(e,t){var n=this.molecule.bonds.get(t);return e!=n.begin?0:n.stereo},chem.Stereocenters._xyzzy=function(e,t,n){var r=.001,i=util.Vec2.cross(e,t),s=util.Vec2.dot(e,t),o=util.Vec2.cross(e,n),u=util.Vec2.dot(e,n);if(Math.abs(i)<r){if(Math.abs(o)<r)throw new Error("degenerate case -- bonds overlap");return o>0?4:8}return i*o<-r*r?2:u<s?2:1},chem.Stereocenters._sign=function(e,t,n){var r=(e.x-n.x)*(t.y-n.y)-(e.y-n.y)*(t.x-n.x),i=.001;if(r>i)return 1;if(r<-i)return-1;throw new Error("degenerate triangle")},chem.Stereocenters.isPyramidMappingRigid=function(e){var t=e.clone(),n=!0;return t[0]>t[1]&&(t.swap(0,1),n=!n),t[1]>t[2]&&(t.swap(1,2),n=!n),t[2]>t[3]&&(t.swap(2,3),n=!n),t[1]>t[2]&&(t.swap(1,2),n=!n),t[0]>t[1]&&(t.swap(0,1),n=!n),t[1]>t[2]&&(t.swap(1,2),n=!n),n};