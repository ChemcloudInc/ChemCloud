/****************************************************************************
 * Copyright (C) 2009-2010 GGA Software Services LLC
 *
 * This file may be distributed and/or modified under the terms of the
 * GNU Affero General Public License version 3 as published by the Free
 * Software Foundation and appearing in the file LICENSE.GPL included in
 * the packaging of this file.
 *
 * This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE
 * WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.
 ***************************************************************************/
if(!window.chem||!util.Vec2||!util.Pool)throw new Error("Vec2, Pool should be defined first");chem.SGroup=function(e){if(!e||!(e in chem.SGroup.TYPES))throw new Error("Invalid or unsupported s-group type");this.type=e,this.id=-1,chem.SGroup.equip(this,e),this.label=-1,this.bracketBox=null,this.bracketDir=new util.Vec2(1,0),this.areas=[],this.highlight=!1,this.highlighting=null,this.selected=!1,this.selectionPlate=null,this.atoms=[],this.patoms=[],this.bonds=[],this.xBonds=[],this.neiAtoms=[],this.pp=null,this.data={mul:1,connectivity:"ht",name:"",subscript:"",attached:!1,absolute:!0,showUnits:!1,nCharsToDisplay:-1,tagChar:"",daspPos:1,fieldType:"F",fieldName:"",units:"",query:"",queryOp:""}},chem.SGroup.prototype.getAttr=function(e){return this.data[e]},chem.SGroup.prototype.getAttrs=function(){var e={};for(var t in this.data)e[t]=this.data[t];return e},chem.SGroup.prototype.setAttr=function(e,t){var n=this.data[e];return this.data[e]=t,n},chem.SGroup.prototype.checkAttr=function(e,t){return this.data[e]==t},chem.SGroup.equip=function(e,t){var n=chem.SGroup.TYPES[t];for(var r in n)e[r]=n[r]},chem.SGroup.numberArrayToString=function(e,t){var n=util.stringPadded(e.length,3);for(var r=0;r<e.length;++r)n+=" "+util.stringPadded(t[e[r]],3);return n},chem.SGroup.addGroup=function(e,t,n){t.id=e.sgroups.add(t),t.postLoad(e,n);for(var r=0;r<t.atoms.length;++r)e.atoms.has(t.atoms[r])&&util.Set.add(e.atoms.get(t.atoms[r]).sgs,t.id);return t.id},chem.SGroup.bracketsToMolfile=function(e,t,n){var r=chem.SGroup.getObjBBox(t.atoms,e);r=r.extend(new util.Vec2(.4,.4)),r.p0=r.p0.yComplement(),r.p1=r.p1.yComplement();var i=[[r.p0.x,r.p1.y,r.p0.x,r.p0.y],[r.p1.x,r.p0.y,r.p1.x,r.p1.y]],s=[];for(var o=0;o<i.length;++o){var u="M  SDI "+n+util.paddedInt(4,3);for(var a=0;a<i[o].length;++a)u+=util.paddedFloat(i[o][a],10,4);s.push(u)}return s},chem.SGroup.filterAtoms=function(e,t){var n=[];for(var r=0;r<e.length;++r){var i=e[r];typeof t[i]!="number"?n.push(i):t[i]>=0?n.push(t[i]):n.push(-1)}return n},chem.SGroup.removeNegative=function(e){var t=[];for(var n=0;n<e.length;++n)e[n]>=0&&t.push(e[n]);return t},chem.SGroup.filter=function(e,t,n){t.atoms=chem.SGroup.removeNegative(chem.SGroup.filterAtoms(t.atoms,n))},chem.SGroup.clone=function(e,t,n){var r=new chem.SGroup(e.type);for(var i in e.data)r.data[i]=e.data[i];return r.atoms=util.mapArray(e.atoms,t),r.pp=e.pp,r.bracketBox=e.bracketBox,r.patoms=null,r.bonds=null,r.allAtoms=e.allAtoms,r},chem.SGroup.addAtom=function(e,t){e.atoms.push(t)},chem.SGroup.removeAtom=function(e,t){for(var n=0;n<e.atoms.length;++n)if(e.atoms[n]==t){e.atoms.splice(n,1);return}throw new Error("The atom is not found in the given s-group")},chem.SGroup.getCrossBonds=function(e,t,n,r){n.bonds.each(function(n,i){util.Set.contains(r,i.begin)&&util.Set.contains(r,i.end)?e!=null&&e.push(n):(util.Set.contains(r,i.begin)||util.Set.contains(r,i.end))&&t!=null&&t.push(n)},this)},chem.SGroup.bracketPos=function(e,t,n){var r=e.atoms;if(n.length!=2)e.bracketDir=new util.Vec2(1,0);else{var i=t.bonds.get(n[0]),s=t.bonds.get(n[1]),o=i.b.center,u=s.b.center;e.bracketDir=util.Vec2.diff(u,o).normalized()}var a=e.bracketDir,f=a.rotateSC(1,0),l=null,c=t.render,h=c.settings;for(var p=0;p<r.length;++p){var d=r[p],v=t.atoms.get(d),m=v.visel.boundingBox;if(m==null){var g=new util.Vec2(util.Vec2.dot(v.a.pp,a),util.Vec2.dot(v.a.pp,f));m=new util.Box2Abs(g,g);var y=new util.Vec2(.05*3,.05*3);m=m.extend(y,y)}else m=m.transform(c.scaled2obj,c);l=l==null?m:util.Box2Abs.union(l,m)}var b=new util.Vec2(.1,.2);l!=null&&(l=l.extend(b,b)),e.bracketBox=l},chem.SGroup.drawBrackets=function(e,t,n,r,i,s,o,u){o=o||new util.Vec2(1,0),u=u||new util.Vec2(0,1);var a=Math.min(.25,s.sz().x*.3),f=util.Vec2.lc2(o,s.p0.x,u,s.p0.y),l=util.Vec2.lc2(o,s.p0.x,u,s.p1.y),c=util.Vec2.lc2(o,s.p1.x,u,s.p0.y),h=util.Vec2.lc2(o,s.p1.x,u,s.p1.y),p=f.addScaled(o,a),d=l.addScaled(o,a),v=c.addScaled(o,-a),m=h.addScaled(o,-a);f=t.obj2scaled(f),l=t.obj2scaled(l),c=t.obj2scaled(c),h=t.obj2scaled(h),p=t.obj2scaled(p),d=t.obj2scaled(d),v=t.obj2scaled(v),m=t.obj2scaled(m);var g=n.path("M{0},{1}L{2},{3}L{4},{5}L{6},{7}",p.x,p.y,f.x,f.y,l.x,l.y,d.x,d.y).attr(i.sgroupBracketStyle),y=n.path("M{0},{1}L{2},{3}L{4},{5}L{6},{7}",v.x,v.y,c.x,c.y,h.x,h.y,m.x,m.y).attr(i.sgroupBracketStyle);e.push(g,y)},chem.SGroup.getObjBBox=function(e,t){if(e.length==0)throw new Error("Atom list is empty");var n=t.atoms.get(e[0]).pp,r=new util.Box2Abs(n,n);for(var i=1;i<e.length;++i){var s=e[i],o=t.atoms.get(s),u=o.pp;r=r.include(u)}return r},chem.SGroup.getBBox=function(e,t){var n=null,r=t.render,i=r.settings;for(var s=0;s<e.length;++s){var o=e[s],u=t.atoms.get(o),a=u.visel.boundingBox;if(a==null){var f=u.a.pp;a=new util.Box2Abs(f,f);var l=new util.Vec2(.15,.15);a=a.extend(l,l)}n=n==null?a:util.Box2Abs.union(n,a)}return n},chem.SGroup.makeAtomBondLines=function(e,t,n,r){if(!n)return[];var i=[];for(var s=0;s<Math.floor((n.length+14)/15);++s){var o=Math.min(n.length-15*s,15),u="M  "+e+" "+t+" "+util.paddedInt(o,2);for(var a=0;a<o;++a)u+=" "+util.paddedInt(r[n[s*15+a]],3);i.push(u)}return i},chem.SGroup.getAtoms=function(e,t){if(!t.allAtoms)return t.atoms;var n=[];return e.atoms.each(function(e){n.push(e)}),n},chem.SGroup.GroupMul={draw:function(e){var t=e.render,n=t.settings,r=t.styles,i=t.paper,s=i.set(),o=[],u=[];chem.SGroup.getCrossBonds(o,u,e.molecule,util.Set.fromList(this.atoms)),chem.SGroup.bracketPos(this,e,u);var a=this.bracketBox,f=this.bracketDir,l=f.rotateSC(1,0);this.areas=[a],chem.SGroup.drawBrackets(s,t,i,n,r,a,f,l);var c=.25,h=util.Vec2.lc(f,f.x<0?a.p0.x-c:a.p1.x+c,l,f.x<0?a.p0.y:a.p1.y);h=t.obj2scaled(h);var p=i.text(h.x,h.y,this.data.mul).attr({font:n.font,"font-size":n.fontszsub}),d=rnd.relBox(p.getBBox());return p.translate(.5*d.width,-0.3*d.height),s.push(p),s},saveToMolfile:function(e,t,n,r){var i=util.stringPadded(t[this.id],3),s=[];s=s.concat(chem.SGroup.makeAtomBondLines("SAL",i,util.idList(this.atomSet),n)),s=s.concat(chem.SGroup.makeAtomBondLines("SPA",i,util.idList(this.parentAtomSet),n)),s=s.concat(chem.SGroup.makeAtomBondLines("SBL",i,this.bonds,r));var o="M  SMT "+i+" "+this.data.mul;return s.push(o),s=s.concat(chem.SGroup.bracketsToMolfile(e,this,i)),s.join("\n")},prepareForSaving:function(e){var t,n;this.atomSet=util.Set.fromList(this.atoms),this.parentAtomSet=util.Set.clone(this.atomSet);var r=[],i=[];e.bonds.each(function(e,t){util.Set.contains(this.parentAtomSet,t.begin)&&util.Set.contains(this.parentAtomSet,t.end)?r.push(e):(util.Set.contains(this.parentAtomSet,t.begin)||util.Set.contains(this.parentAtomSet,t.end))&&i.push(e)},this);if(i.length!=0&&i.length!=2)throw{id:this.id,"error-type":"cross-bond-number",message:"Unsupported cross-bonds number"};var s=-1,o=-1,u=null;if(i.length==2){var a=e.bonds.get(i[0]);util.Set.contains(this.parentAtomSet,a.begin)?s=a.begin:s=a.end;var f=e.bonds.get(i[1]);util.Set.contains(this.parentAtomSet,f.begin)?o=f.begin:o=f.end,u=f}var l=null,c=s;for(n=0;n<this.data.mul-1;++n){l={};for(t=0;t<this.atoms.length;++t){var h=this.atoms[t],p=e.atoms.get(h),d=e.atoms.add(new chem.Struct.Atom(p));this.atomSet[d]=1,l[h]=d}for(t=0;t<r.length;++t){var v=e.bonds.get(r[t]),m=new chem.Struct.Bond(v);m.begin=l[m.begin],m.end=l[m.end],e.bonds.add(m)}if(u!=null){var g=new chem.Struct.Bond(u);g.begin=c,g.end=l[o],e.bonds.add(g),c=l[s]}}if(c>=0){var y=e.bonds.get(i[0]);y.begin==s?y.begin=c:y.end=c}this.bonds=i},postLoad:function(e,t){this.data.mul=this.data.subscript-0;var n={};this.atoms=chem.SGroup.filterAtoms(this.atoms,t),this.patoms=chem.SGroup.filterAtoms(this.patoms,t);for(var r=1;r<this.data.mul;++r)for(var i=0;i<this.patoms.length;++i){var s=this.atoms[r*this.patoms.length+i];if(s<0)continue;if(this.patoms[i]<0)throw new Error("parent atom missing");n[s]=this.patoms[i]}this.patoms=chem.SGroup.removeNegative(this.patoms);var o=util.identityMap(this.patoms),u=[];e.bonds.each(function(e,t){var r=t.begin in n,i=t.end in n;r&&i||r&&t.end in o||i&&t.begin in o?u.push(e):r?t.begin=n[t.begin]:i&&(t.end=n[t.end])},this);for(var a=0;a<u.length;++a)e.bonds.remove(u[a]);for(var f in n)e.atoms.remove(f),t[f]=-1;this.atoms=this.patoms,this.patoms=null}},chem.SGroup.GroupSru={draw:function(e){var t=e.render,n=t.settings,r=t.styles,i=t.paper,s=i.set(),o=[],u=[];chem.SGroup.getCrossBonds(o,u,e.molecule,util.Set.fromList(this.atoms)),chem.SGroup.bracketPos(this,e,u);var a=this.bracketBox,f=this.bracketDir,l=f.rotateSC(1,0);this.areas=[a],chem.SGroup.drawBrackets(s,t,i,n,r,a,f,l);var c=this.data.connectivity||"eu",h=.25;if(c!="ht"){var p=util.Vec2.lc(f,f.x<0?a.p0.x-h:a.p1.x+h,l,f.x>=0?a.p0.y:a.p1.y);p=t.obj2scaled(p);var d=i.text(p.x,p.y,c).attr({font:n.font,"font-size":n.fontszsub});s.push(d)}this.data.subscript=this.data.subscript||"n",p=util.Vec2.lc(f,f.x<0?a.p0.x-h:a.p1.x+h,l,f.x<0?a.p0.y:a.p1.y),p=t.obj2scaled(p);var v=i.text(p.x,p.y,this.data.subscript).attr({font:n.font,"font-size":n.fontszsub});return s.push(v),s},saveToMolfile:function(e,t,n,r){var i=util.stringPadded(t[this.id],3),s=[];return s=s.concat(chem.SGroup.makeAtomBondLines("SAL",i,this.atoms,n)),s=s.concat(chem.SGroup.makeAtomBondLines("SBL",i,this.bonds,r)),s=s.concat(chem.SGroup.bracketsToMolfile(e,this,i)),s.join("\n")},prepareForSaving:function(e){var t=[];e.bonds.each(function(n,r){var i=e.atoms.get(r.begin),s=e.atoms.get(r.end);(util.Set.contains(i.sgs,this.id)&&!util.Set.contains(s.sgs,this.id)||util.Set.contains(s.sgs,this.id)&&!util.Set.contains(i.sgs,this.id))&&t.push(n)},this),this.bonds=t},postLoad:function(e,t){this.data.connectivity=(this.data.connectivity||"EU").strip().toLowerCase()}},chem.SGroup.GroupSup={draw:function(e){var t=e.render,n=t.settings,r=t.styles,i=t.paper,s=i.set(),o=[],u=[];chem.SGroup.getCrossBonds(o,u,e.molecule,util.Set.fromList(this.atoms)),chem.SGroup.bracketPos(this,e,u);var a=this.bracketBox,f=this.bracketDir,l=f.rotateSC(1,0);this.areas=[a],chem.SGroup.drawBrackets(s,t,i,n,r,a,f,l);if(this.data.name){var c=.25,h=util.Vec2.lc(f,f.x<0?a.p0.x-c:a.p1.x+c,l,f.x<0?a.p0.y:a.p1.y);h=t.obj2scaled(h);var p=i.text(h.x,h.y,this.data.name).attr({font:n.font,"font-size":n.fontszsub,"font-style":"italic"}),d=rnd.relBox(p.getBBox());p.translate(.5*d.width*f.x,0),s.push(p)}return s},saveToMolfile:function(e,t,n,r){var i=util.stringPadded(t[this.id],3),s=[];return s=s.concat(chem.SGroup.makeAtomBondLines("SAL",i,this.atoms,n)),s=s.concat(chem.SGroup.makeAtomBondLines("SBL",i,this.bonds,r)),this.data.name&&this.data.name!=""&&s.push("M  SMT "+i+" "+this.data.name),s.join("\n")},prepareForSaving:function(e){var t=[];e.bonds.each(function(n,r){var i=e.atoms.get(r.begin),s=e.atoms.get(r.end);(util.Set.contains(i.sgs,this.id)&&!util.Set.contains(s.sgs,this.id)||util.Set.contains(s.sgs,this.id)&&!util.Set.contains(i.sgs,this.id))&&t.push(n)},this),this.bonds=t},postLoad:function(e,t){this.data.name=(this.data.subscript||"").strip()}},chem.SGroup.GroupGen={draw:function(e){var t=e.render,n=t.settings,r=t.styles,i=t.paper,s=i.set(),o=[],u=[];chem.SGroup.getCrossBonds(o,u,e.molecule,util.Set.fromList(this.atoms)),chem.SGroup.bracketPos(this,e,u);var a=this.bracketBox,f=this.bracketDir,l=f.rotateSC(1,0);return this.areas=[a],chem.SGroup.drawBrackets(s,t,i,n,r,a,f,l),s},saveToMolfile:function(e,t,n,r){var i=util.stringPadded(t[this.id],3),s=[];return s=s.concat(chem.SGroup.makeAtomBondLines("SAL",i,this.atoms,n)),s=s.concat(chem.SGroup.makeAtomBondLines("SBL",i,this.bonds,r)),s=s.concat(chem.SGroup.bracketsToMolfile(e,this,i)),s.join("\n")},prepareForSaving:function(e){},postLoad:function(e,t){}},chem.SGroup.getMassCentre=function(e,t){var n=new util.Vec2;for(var r=0;r<t.length;++r)n=n.addScaled(e.atoms.get(t[r]).pp,1/t.length);return n},chem.SGroup.setPos=function(e,t,n){t.pp=n},chem.SGroup.GroupDat={showValue:function(e,t,n,r){var i=e.text(t.x,t.y,n.data.fieldValue).attr({font:r.font,"font-size":r.fontsz});return i},draw:function(e){var t=e.render,n=t.settings,r=t.paper,i=r.set(),s=this.data.absolute||this.allAtoms,o=chem.SGroup.getAtoms(e,this),u,a=[],f=[];chem.SGroup.getCrossBonds(a,f,e.molecule,util.Set.fromList(this.atoms)),chem.SGroup.bracketPos(this,e,f),this.areas=[this.bracketBox],this.pp==null&&chem.SGroup.setPos(e,this,this.bracketBox.p1.add(new util.Vec2(.5,.5)));var l=this.pp.scaled(n.scaleFactor);if(this.data.attached)for(u=0;u<o.length;++u){var c=e.atoms.get(o[u]),h=t.ps(c.a.pp),p=c.visel.boundingBox;p!=null&&(h.x=Math.max(h.x,p.p1.x)),h.x+=n.lineWidth;var d=this.showValue(r,h,this,n),v=rnd.relBox(d.getBBox());d.translate(.5*v.width,-0.3*v.height),i.push(d);var m=util.Box2Abs.fromRelBox(rnd.relBox(d.getBBox()));this.areas.push(m.transform(t.scaled2obj,t))}else{var g=this.showValue(r,l,this,n),y=rnd.relBox(g.getBBox());g.translate(.5*y.width,-0.5*y.height),i.push(g);var b=util.Box2Abs.fromRelBox(rnd.relBox(g.getBBox()));this.dataArea=b.transform(t.scaled2obj,t),e.sgroupData.has(this.id)||e.sgroupData.set(this.id,new rnd.ReDataSGroupData(this))}return i},saveToMolfile:function(e,t,n,r){var i=util.stringPadded(t[this.id],3),s=this.data,o=this.pp;s.absolute||(o=o.sub(chem.SGroup.getMassCentre(e,this.atoms)));var u=[];u=u.concat(chem.SGroup.makeAtomBondLines("SAL",i,this.atoms,n));var a="M  SDT "+i+" "+util.stringPadded(s.fieldName,30,!0)+util.stringPadded(s.fieldType,2)+util.stringPadded(s.units,20,!0)+util.stringPadded(s.query,2)+util.stringPadded(s.queryOp,3);u.push(a);var f="M  SDD "+i+" "+util.paddedFloat(o.x,10,4)+util.paddedFloat(-o.y,10,4)+"    "+(s.attached?"A":"D")+(s.absolute?"A":"R")+(s.showUnits?"U":" ")+"   "+(s.nCharnCharsToDisplay>=0?util.paddedInt(s.nCharnCharsToDisplay,3):"ALL")+"  1   "+util.stringPadded(s.tagChar,1)+"  "+util.paddedInt(s.daspPos,1)+"  ";u.push(f);var l=s.fieldValue,c=69;while(l.length>c)u.push("M  SCD "+i+" "+l.slice(0,c)),l=l.slice(69);return u.push("M  SED "+i+" "+util.stringPadded(l,c,!0)),u.join("\n")},prepareForSaving:function(e){this.atoms=chem.SGroup.getAtoms(e,this)},postLoad:function(e,t){var n=this.atoms.length==e.atoms.count();this.data.absolute||(this.pp=this.pp.add(chem.SGroup.getMassCentre(e,this.atoms))),n&&(this.data.fieldName=="MDLBG_FRAGMENT_STEREO"||this.data.fieldName=="MDLBG_FRAGMENT_COEFFICIENT"||this.data.fieldName=="MDLBG_FRAGMENT_CHARGE")&&(this.atoms=[],this.allAtoms=!0)}},chem.SGroup.TYPES={MUL:chem.SGroup.GroupMul,SRU:chem.SGroup.GroupSru,SUP:chem.SGroup.GroupSup,DAT:chem.SGroup.GroupDat,GEN:chem.SGroup.GroupGen};