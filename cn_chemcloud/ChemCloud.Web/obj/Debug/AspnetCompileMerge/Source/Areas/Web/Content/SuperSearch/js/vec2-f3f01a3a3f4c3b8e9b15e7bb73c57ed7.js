/****************************************************************************
 * Copyright (C) 2009-2010 GGA Software Services LLC
 *
 * This file may be distributed and/or modified under the terms of the
 * GNU Affero General Public License version 3 as published by the Free
 * Software Foundation and appearing in the file LICENSE.GPL included in
 * the packaging of this file.
 *
 * This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE
 * WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.
 ***************************************************************************/
// 2d-vector constructor and utilities
window.util||(util={}),util.assertDefined=function(){},util.Vec2=function(e,t){if(arguments.length==0)this.x=0,this.y=0;else if(arguments.length==1)this.x=parseFloat(e.x),this.y=parseFloat(e.y);else{if(arguments.length!=2)throw"util.Vec2(): invalid arguments";this.x=parseFloat(e),this.y=parseFloat(t)}},util.Vec2.ZERO=new util.Vec2(0,0),util.Vec2.UNIT=new util.Vec2(1,1),util.Vec2.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},util.Vec2.prototype.equals=function(e){return util.assertDefined(e),this.x==e.x&&this.y==e.y},util.Vec2.prototype.add=function(e){return util.assertDefined(e),new util.Vec2(this.x+e.x,this.y+e.y)},util.Vec2.prototype.add_=function(e){util.assertDefined(e),this.x+=e.x,this.y+=e.y},util.Vec2.prototype.sub=function(e){return util.assertDefined(e),new util.Vec2(this.x-e.x,this.y-e.y)},util.Vec2.prototype.scaled=function(e){return util.assertDefined(e),new util.Vec2(this.x*e,this.y*e)},util.Vec2.prototype.negated=function(){return new util.Vec2(-this.x,-this.y)},util.Vec2.prototype.yComplement=function(e){return e=e||0,new util.Vec2(this.x,e-this.y)},util.Vec2.prototype.addScaled=function(e,t){return util.assertDefined(e),util.assertDefined(t),new util.Vec2(this.x+e.x*t,this.y+e.y*t)},util.Vec2.prototype.normalized=function(){return this.scaled(1/this.length())},util.Vec2.prototype.normalize=function(){var e=this.length();return e<1e-6?!1:(this.x/=e,this.y/=e,!0)},util.Vec2.prototype.turnLeft=function(){return new util.Vec2(-this.y,this.x)},util.Vec2.prototype.toString=function(){return"("+this.x.toFixed(2)+","+this.y.toFixed(2)+")"},util.Vec2.dist=function(e,t){return util.assertDefined(e),util.assertDefined(t),util.Vec2.diff(e,t).length()},util.Vec2.max=function(e,t){return util.assertDefined(e),util.assertDefined(t),new util.Vec2(Math.max(e.x,t.x),Math.max(e.y,t.y))},util.Vec2.min=function(e,t){return util.assertDefined(e),util.assertDefined(t),new util.Vec2(Math.min(e.x,t.x),Math.min(e.y,t.y))},util.Vec2.prototype.max=function(e){return util.assertDefined(e),new util.Vec2.max(this,e)},util.Vec2.prototype.min=function(e){return util.assertDefined(e),new util.Vec2.min(this,e)},util.Vec2.prototype.ceil=function(){return new util.Vec2(Math.ceil(this.x),Math.ceil(this.y))},util.Vec2.prototype.floor=function(){return new util.Vec2(Math.floor(this.x),Math.floor(this.y))},util.Vec2.sum=function(e,t){return util.assertDefined(e),util.assertDefined(t),new util.Vec2(e.x+t.x,e.y+t.y)},util.Vec2.dot=function(e,t){return util.assertDefined(e),util.assertDefined(t),e.x*t.x+e.y*t.y},util.Vec2.cross=function(e,t){return util.assertDefined(e),util.assertDefined(t),e.x*t.y-e.y*t.x},util.Vec2.prototype.rotate=function(e){util.assertDefined(e);var t=Math.sin(e),n=Math.cos(e);return this.rotateSC(t,n)},util.Vec2.prototype.rotateSC=function(e,t){return util.assertDefined(e),util.assertDefined(t),new util.Vec2(this.x*t-this.y*e,this.x*e+this.y*t)},util.Vec2.angle=function(e,t){return util.assertDefined(e),util.assertDefined(t),Math.atan2(util.Vec2.cross(e,t),util.Vec2.dot(e,t))},util.Vec2.prototype.oxAngle=function(){return Math.atan2(this.y,this.x)},util.Vec2.diff=function(e,t){return util.assertDefined(e),util.assertDefined(t),new util.Vec2(e.x-t.x,e.y-t.y)},util.Vec2.lc=function(){var e=new util.Vec2;for(var t=0;t<arguments.length/2;++t)e=e.addScaled(arguments[2*t],arguments[2*t+1]);return e},util.Vec2.lc2=function(e,t,n,r){return util.assertDefined(e),util.assertDefined(n),util.assertDefined(t),util.assertDefined(r),new util.Vec2(e.x*t+n.x*r,e.y*t+n.y*r)},util.Box2Abs=function(){arguments.length==1&&"min"in arguments[0]&&"max"in arguments[0]&&(this.p0=arguments[0].min,this.p1=arguments[0].max),arguments.length==2&&arguments[0]instanceof util.Vec2&&arguments[1]instanceof util.Vec2?(this.p0=arguments[0],this.p1=arguments[1]):arguments.length==4?(this.p0=new util.Vec2(arguments[0],arguments[1]),this.p1=new util.Vec2(arguments[2],arguments[3])):arguments.length==0?(this.p0=new util.Vec2,this.p1=new util.Vec2):new Error("util.Box2Abs constructor only accepts 4 numbers or 2 vectors or no arguments!")},util.Box2Abs.prototype.toString=function(){return this.p0.toString()+" "+this.p1.toString()},util.Box2Abs.fromRelBox=function(e){return util.assertDefined(e),new util.Box2Abs(e.x,e.y,e.x+e.width,e.y+e.height)},util.Box2Abs.prototype.clone=function(){return new util.Box2Abs(this.p0,this.p1)},util.Box2Abs.union=function(e,t){return util.assertDefined(e),util.assertDefined(t),new util.Box2Abs(util.Vec2.min(e.p0,t.p0),util.Vec2.max(e.p1,t.p1))},util.Box2Abs.prototype.extend=function(e,t){return util.assertDefined(e),t=t||e,new util.Box2Abs(this.p0.sub(e),this.p1.add(t))},util.Box2Abs.prototype.include=function(e){return util.assertDefined(e),new util.Box2Abs(this.p0.min(e),this.p1.max(e))},util.Box2Abs.prototype.translate=function(e){return util.assertDefined(e),new util.Box2Abs(this.p0.add(e),this.p1.add(e))},util.Box2Abs.prototype.transform=function(e,t){return new util.Box2Abs(e.call(t,this.p0),e.call(t,this.p1))},util.Box2Abs.prototype.sz=function(){return this.p1.sub(this.p0)},util.Box2Abs.prototype.pos=function(){return this.p0},util.Vec2.shiftRayBox=function(e,t,n){util.assertDefined(e),util.assertDefined(t),util.assertDefined(n);var r=[n.p0,new util.Vec2(n.p1.x,n.p0.y),n.p1,new util.Vec2(n.p0.x,n.p1.y)],i=r.map(function(t){return t.sub(e)});t=t.normalized();var s=i.map(function(e){return util.Vec2.cross(e,t)}),o=i.map(function(e){return util.Vec2.dot(e,t)}),u=-1,a=-1;for(var f=0;f<4;++f)if(s[f]>0){if(u<0||o[u]<o[f])u=f}else if(a<0||o[a]<o[f])a=f;if(a<0||u<0)return 0;var l,c;return o[u]>o[a]?(l=a,c=u):(l=u,c=a),o[l]+Math.abs(s[l])*(o[c]-o[l])/(Math.abs(s[l])+Math.abs(s[c]))};