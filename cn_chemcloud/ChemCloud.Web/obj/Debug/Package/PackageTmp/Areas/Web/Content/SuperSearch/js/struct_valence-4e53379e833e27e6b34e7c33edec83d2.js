/****************************************************************************
 * Copyright (C) 2009-2010 GGA Software Services LLC
 *
 * This file may be distributed and/or modified under the terms of the
 * GNU Affero General Public License version 3 as published by the Free
 * Software Foundation and appearing in the file LICENSE.GPL included in
 * the packaging of this file.
 *
 * This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE
 * WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.
 ***************************************************************************/
if(!window.chem||!chem.Struct)throw new Error("Include MolData.js first");chem.Struct.prototype.calcConn=function(e){var t=0,n=this.atoms.get(e),r=!1;for(var i=0;i<n.neighbors.length;++i){var s=this.halfBonds.get(n.neighbors[i]),o=this.bonds.get(s.bid);switch(o.type){case chem.Struct.BOND.TYPE.SINGLE:t+=1;break;case chem.Struct.BOND.TYPE.DOUBLE:t+=2;break;case chem.Struct.BOND.TYPE.TRIPLE:t+=3;break;case chem.Struct.BOND.TYPE.AROMATIC:t+=1,r=!0;break;default:return-1}}return r&&(t+=1),t},chem.Struct.Atom.prototype.calcValence=function(e){var t=this,n=t.charge,r=t.label;if(t.isQuery())return this.valence=-1,this.implicitH=-1,!0;var i=chem.Element.getElementByLabel(r);if(i==null)return this.valence=-1,this.implicitH=0,!0;var s=chem.Element.elements.get(i).group,o=chem.Struct.radicalElectrons(t.radical),u=e,a=0,f=Math.abs(n);if(s==1){if(r=="H"||r=="Li"||r=="Na"||r=="K"||r=="Rb"||r=="Cs"||r=="Fr")u=1,a=1-o-e-f}else if(s==3)r=="B"||r=="Al"||r=="Ga"||r=="In"?n==-1?(u=4,a=4-o-e):(u=3,a=3-o-e-f):r=="Tl"&&(n==-1?o+e<=2?(u=2,a=2-o-e):(u=4,a=4-o-e):n==-2?o+e<=3?(u=3,a=3-o-e):(u=5,a=5-o-e):o+e+f<=1?(u=1,a=1-o-e-f):(u=3,a=3-o-e-f));else if(s==4){if(r=="C"||r=="Si"||r=="Ge")u=4,a=4-o-e-f;else if(r=="Sn"||r=="Pb")e+o+f<=2?(u=2,a=2-o-e-f):(u=4,a=4-o-e-f)}else if(s==5){if(r=="N"||r=="P")n==1?(u=4,a=4-o-e):n==2?(u=3,a=3-o-e):r=="N"||o+e+f<=3?(u=3,a=3-o-e-f):(u=5,a=5-o-e-f);else if(r=="Bi"||r=="Sb"||r=="As")n==1?o+e<=2&&r!="As"?(u=2,a=2-o-e):(u=4,a=4-o-e):n==2?(u=3,a=3-o-e):o+e<=3?(u=3,a=3-o-e-f):(u=5,a=5-o-e-f)}else if(s==6){if(r=="O")n>=1?(u=3,a=3-o-e):(u=2,a=2-o-e-f);else if(r=="S"||r=="Se"||r=="Po")n==1?e<=3?(u=3,a=3-o-e):(u=5,a=5-o-e):e+o+f<=2?(u=2,a=2-o-e-f):e+o+f<=4?(u=4,a=4-o-e-f):(u=6,a=6-o-e-f);else if(r=="Te")if(n==-1)e<=2&&(u=2,a=2-o-e-f);else if(n==0||n==2)e<=2?(u=2,a=2-o-e-f):e<=4?(u=4,a=4-o-e-f):n==0&&e<=6?(u=6,a=6-o-e-f):a=-1}else if(s==7)if(r=="F")u=1,a=1-o-e-f;else if(r=="Cl"||r=="Br"||r=="I"||r=="At")if(n==1){if(e<=2)u=2,a=2-o-e;else if(e==3||e==5||e>=7)a=-1}else n==0&&(e<=1?(u=1,a=1-o-e):e==2||e==4||e==6?o==1?(u=e,a=0):a=-1:e>7&&(a=-1));return this.valence=u,this.implicitH=a,this.implicitH<0?(this.valence=e,this.implicitH=0,this.badConn=!0,!1):!0},chem.Struct.Atom.prototype.calcValenceMinusHyd=function(e){var t=this,n=t.charge,r=t.label,i=chem.Element.getElementByLabel(r);if(i==null)throw new Error("Element "+r+" unknown");if(i<0)return this.valence=-1,this.implicitH=-1,null;var s=chem.Element.elements.get(i).group,o=chem.Struct.radicalElectrons(t.radical);if(s==3){if(r=="B"||r=="Al"||r=="Ga"||r=="In")if(n==-1&&o+e<=4)return o+e}else if(s==5){if(r=="N"||r=="P"){if(n==1)return o+e;if(n==2)return o+e}else if(r=="Sb"||r=="Bi"||r=="As"){if(n==1)return o+e;if(n==2)return o+e}}else if(s==6){if(r=="O"){if(n>=1)return o+e}else if(r=="S"||r=="Se"||r=="Po")if(n==1)return o+e}else if(s==7&&(r=="Cl"||r=="Br"||r=="I"||r=="At")&&n==1)return o+e;return o+e+Math.abs(n)},chem.Struct.prototype.calcImplicitHydrogen=function(e){var t=this.calcConn(e),n=this.atoms.get(e);if(t<0){n.implicitH=-1;return}n.badConn=!1;if(n.explicitValence){var r=chem.Element.getElementByLabel(n.label);n.implicitH=0,r!=null&&(n.implicitH=n.valence-n.calcValenceMinusHyd(t),n.implicitH<0&&(n.implicitH=-1,n.badConn=!0))}else n.calcValence(t)};