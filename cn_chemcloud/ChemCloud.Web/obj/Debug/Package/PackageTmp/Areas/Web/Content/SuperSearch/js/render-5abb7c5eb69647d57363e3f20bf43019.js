/****************************************************************************
 * Copyright (C) 2009-2010 GGA Software Services LLC
 *
 * This file may be distributed and/or modified under the terms of the
 * GNU Affero General Public License version 3 as published by the Free
 * Software Foundation and appearing in the file LICENSE.GPL included in
 * the packaging of this file.
 *
 * This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE
 * WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.
 ***************************************************************************/
if(!window.Prototype)throw new Error("Prototype.js should be loaded first");if(!window.rnd||!rnd.ReStruct)throw new Error("rnd.MolData should be defined prior to loading this file");rnd.DEBUG=!1,rnd.logcnt=0,rnd.logmouse=!1,rnd.hl=!1,rnd.mouseEventNames=["Click","DblClick","MouseOver","MouseDown","MouseMove","MouseOut"],rnd.logMethod=function(){},rnd.RenderDummy=function(e,t,n,r){this.clientArea=e=$(e),e.innerHTML="",this.paper=new Raphael(e),this.paper.rect(0,0,100,100).attr({fill:"#0F0",stroke:"none"}),this.setMolecule=function(){},this.update=function(){}},rnd.Render=function(e,t,n,r){this.opt=n||{},this.opt.showSelectionRegions=this.opt.showSelectionRegions||!1,this.opt.showAtomIds=this.opt.showAtomIds||!1,this.opt.showBondIds=this.opt.showBondIds||!1,this.opt.showHalfBondIds=this.opt.showHalfBondIds||!1,this.opt.showLoopIds=this.opt.showLoopIds||!1,this.opt.showValenceWarnings=Object.isUndefined(this.opt.showValenceWarnings)?!0:this.opt.showValenceWarnings,this.opt.autoScale=this.opt.autoScale||!1,this.opt.autoScaleMargin=this.opt.autoScaleMargin||0,this.opt.atomColoring=this.opt.atomColoring||0,this.opt.hideImplicitHydrogen=this.opt.hideImplicitHydrogen||!1,this.opt.hideTerminalLabels=this.opt.hideTerminalLabels||!1,this.opt.ignoreMouseEvents=this.opt.ignoreMouseEvents||!1,this.opt.selectionDistanceCoefficient=(this.opt.selectionDistanceCoefficient||.4)-0,this.useOldZoom=Prototype.Browser.IE,this.scale=t||100,this.baseScale=this.scale,this.offset=new util.Vec2,this.clientArea=e=$(e),e.innerHTML="",this.paper=new Raphael(e),this.size=new util.Vec2,this.viewSz=r||new util.Vec2(e.clientWidth||100,e.clientHeight||100),this.bb=new util.Box2Abs(new util.Vec2,this.viewSz),this.curItem={type:"Canvas",id:-1},this.pagePos=new util.Vec2,this.muteMouseOutMouseOver=!1,this.dirty=!0,this.selectionRect=null,this.rxnArrow=null,this.rxnMode=!1,this.zoom=1;var i=this,s=0,o=0,u=e;do s+=u.offsetTop||0,o+=u.offsetLeft||0,u=u.offsetParent;while(u);this.clientAreaPos=new util.Vec2(o,s),e.observe("touchstart",function(e){e.touches.length==2&&(this._tui=this._tui||{},this._tui.center={pageX:(e.touches[0].pageX+e.touches[1].pageX)/2,pageY:(e.touches[0].pageY+e.touches[1].pageY)/2},ui.setZoomStaticPointInit(ui.page2obj(this._tui.center)))}),e.observe("touchmove",function(e){"_tui"in this&&e.touches.length==2&&(this._tui.center={pageX:(e.touches[0].pageX+e.touches[1].pageX)/2,pageY:(e.touches[0].pageY+e.touches[1].pageY)/2})}),e.observe("gesturestart",function(e){this._tui=this._tui||{},this._tui.scale0=ui.render.zoom,e.preventDefault()}),e.observe("gesturechange",function(e){ui.setZoomStaticPoint(this._tui.scale0*e.scale,ui.page2canvas2(this._tui.center)),ui.render.update(),e.preventDefault()}),e.observe("gestureend",function(e){delete this._tui,e.preventDefault()}),e.observe("onresize",function(e){i.onResize()}),"hiddenPaths"in rnd.ReStruct.prototype&&e.observe("touchend",function(e){if(e.touches.length==0)while(rnd.ReStruct.prototype.hiddenPaths.length>0)rnd.ReStruct.prototype.hiddenPaths.pop().remove()}),e.observe("mouseup",function(e){ui.render.current_tool&&ui.render.current_tool.processEvent("OnMouseUp",e)}),e.observe("touchend",function(e){e.touches.length==0&&ui.render.current_tool&&ui.render.current_tool.processEvent("OnMouseUp",new rnd.MouseEvent(e))}),this.opt.ignoreMouseEvents||rnd.mouseEventNames.each(function(t){var n=t.toLowerCase();n=EventMap[n]||n,e.observe(n,function(r){if(!ui||!ui.is_touch){var s=e.cumulativeOffset();s=new util.Vec2(s[0],s[1]);var o=(new util.Vec2(r.clientX,r.clientY)).sub(s),u=new util.Vec2(e.clientWidth,e.clientHeight);if(!(o.x>0&&o.y>0&&o.x<u.x&&o.y<u.y))return util.preventDefault(r)}var a=ui.render.current_tool&&ui.render.current_tool.processEvent("On"+t,r),f="_onCanvas"+t;!ui.render.current_tool&&(!("touches"in r)||r.touches.length==1)&&i[f]&&i[f](new rnd.MouseEvent(r)),util.stopEventPropagation(r);if(n!="touchstart"&&(n!="touchmove"||r.touches.length!=2))return util.preventDefault(r)})},this),this.ctab=new rnd.ReStruct(new chem.Struct,this),this.settings=null,this.styles=null,this.checkCurItem=!0,this.onCanvasOffsetChanged=null,this.onCanvasSizeChanged=null},rnd.Render.prototype.setCurrentItem=function(e,t,n){if(this.current_tool)return;var r=this.curItem.type,i=this.curItem.id;if(e!=r||t!=i)this.curItem={type:e,id:t},(r=="Canvas"||r=="Atom"&&this.ctab.atoms.has(i)||r=="RxnArrow"&&this.ctab.rxnArrows.has(i)||r=="RxnPlus"&&this.ctab.rxnPluses.has(i)||r=="Bond"&&this.ctab.bonds.has(i)||r=="SGroup"&&this.ctab.sgroups.has(i))&&this.callEventHandler(n,"MouseOut",r,i),this.callEventHandler(n,"MouseOver",e,t)},rnd.Render.prototype.view2scaled=function(e,t){return this.useOldZoom||(e=e.scaled(1/this.zoom)),e=t?e:e.add(ui.scrollPos().scaled(1/this.zoom)).sub(this.offset),e},rnd.Render.prototype.scaled2view=function(e,t){return e=t?e:e.add(this.offset).sub(ui.scrollPos().scaled(1/this.zoom)),this.useOldZoom||(e=e.scaled(this.zoom)),e},rnd.Render.prototype.scaled2obj=function(e){return e.scaled(1/this.settings.scaleFactor)},rnd.Render.prototype.obj2scaled=function(e){return e.scaled(this.settings.scaleFactor)},rnd.Render.prototype.view2obj=function(e,t){return this.scaled2obj(this.view2scaled(e,t))},rnd.Render.prototype.obj2view=function(e,t){return this.scaled2view(this.obj2scaled(e,t))},rnd.Render.prototype.checkCurrentItem=function(e){if(this.current_tool)return;if(this.offset){this.pagePos=new util.Vec2(e.pageX,e.pageY);var t=null;"ui"in window&&"page2obj"in ui?t=new util.Vec2(ui.page2obj(e)):t=this.pagePos.sub(this.clientAreaPos);var n=this.findClosestItem(t);this.setCurrentItem(n.type,n.id,e)}},rnd.Render.prototype.findItem=function(e,t,n){var r=this.findClosestItem("ui"in window&&"page2obj"in ui?new util.Vec2(ui.page2obj(e)):(new util.Vec2(e.pageX,e.pageY)).sub(this.clientAreaPos),t,n);return r.type=="Atom"?r.map="atoms":r.type=="Bond"?r.map="bonds":r.type=="SGroup"?r.map="sgroups":r.type=="DataSGroupData"?r.map="sgroupData":r.type=="RxnArrow"?r.map="rxnArrows":r.type=="RxnPlus"?r.map="rxnPluses":r.type=="Fragment"?r.map="frags":r.type=="RGroup"?r.map="rgroups":r.type=="ChiralFlag"&&(r.map="chiralFlags"),r},rnd.Render.prototype.client2Obj=function(e){return(new util.Vec2(e)).sub(this.offset)},rnd.Render.prototype.callEventHandler=function(e,t,n,r){if(this.current_tool)return;var i="on"+n+t,s=!1;this[i]&&(s=this[i](e,r));if(!s&&n!="Canvas"){var o="onCanvas"+t;this[o]&&(s=this[o](e))}},util.each(["MouseMove","MouseDown","MouseUp","Click","DblClick"],function(e){rnd.Render.prototype["_onCanvas"+e]=function(t){this.checkCurrentItem(t),this.callEventHandler(t,e,this.curItem.type,this.curItem.id)}}),rnd.Render.prototype.setMolecule=function(e,t){rnd.logMethod("setMolecule"),this.paper.clear(),this.ctab=new rnd.ReStruct(e,this,t),this.offset=null,this.size=null,this.bb=null,this.rxnMode=e.isReaction},rnd.Render.prototype.atomGetAttr=function(e,t){return rnd.logMethod("atomGetAttr"),this.ctab.molecule.atoms.get(e)[t]},rnd.Render.prototype.invalidateAtom=function(e,t){var n=this.ctab.atoms.get(e);this.ctab.markAtom(e,t?1:0);var r=this.ctab.molecule.halfBonds;for(var i=0;i<n.a.neighbors.length;++i){var s=n.a.neighbors[i];if(r.has(s)){var o=r.get(s);this.ctab.markBond(o.bid,1),this.ctab.markAtom(o.end,0)}}},rnd.Render.prototype.invalidateBond=function(e,t){var n=this.ctab.bonds.get(e);this.invalidateAtom(n.b.begin,0),this.invalidateAtom(n.b.end,0);if(t){var r=this.ctab.molecule.halfBonds.get(n.b.hb1).loop,i=this.ctab.molecule.halfBonds.get(n.b.hb2).loop;r>=0&&this.ctab.loopRemove(r),i>=0&&this.ctab.loopRemove(i)}},rnd.Render.prototype.invalidateItem=function(e,t,n){e=="atoms"?this.invalidateAtom(t,n):e=="bonds"?this.invalidateBond(t,n):this.ctab.markItem(e,t,n)},rnd.Render.prototype.atomGetDegree=function(e){return rnd.logMethod("atomGetDegree"),this.ctab.atoms.get(e).a.neighbors.length},rnd.Render.prototype.isBondInRing=function(e){var t=this.ctab.bonds.get(e);return this.ctab.molecule.halfBonds.get(t.b.hb1).loop>=0||this.ctab.molecule.halfBonds.get(t.b.hb2).loop>=0},rnd.Render.prototype.atomGetNeighbors=function(e){var t=this.ctab.atoms.get(e),n=[];for(var r=0;r<t.a.neighbors.length;++r){var i=this.ctab.molecule.halfBonds.get(t.a.neighbors[r]);n.push({aid:i.end-0,bid:i.bid-0})}return n},rnd.Render.prototype.atomGetSGroups=function(e){rnd.logMethod("atomGetSGroups");var t=this.ctab.atoms.get(e);return util.Set.list(t.a.sgs)},rnd.Render.prototype.sGroupGetAttr=function(e,t){return rnd.logMethod("sGroupGetAttr"),this.ctab.sgroups.get(e).item.getAttr(t)},rnd.Render.prototype.sGroupGetAttrs=function(e){return rnd.logMethod("sGroupGetAttrs"),this.ctab.sgroups.get(e).item.getAttrs()},rnd.Render.prototype.sGroupGetAtoms=function(e){rnd.logMethod("sGroupGetAtoms");var t=this.ctab.sgroups.get(e).item;return chem.SGroup.getAtoms(this.ctab.molecule,t)},rnd.Render.prototype.sGroupGetType=function(e){rnd.logMethod("sGroupGetType");var t=this.ctab.sgroups.get(e).item;return t.type},rnd.Render.prototype.sGroupsFindCrossBonds=function(){rnd.logMethod("sGroupsFindCrossBonds"),this.ctab.molecule.sGroupsRecalcCrossBonds()},rnd.Render.prototype.sGroupGetNeighborAtoms=function(e){rnd.logMethod("sGroupGetNeighborAtoms");var t=this.ctab.sgroups.get(e).item;return t.neiAtoms},rnd.Render.prototype.atomIsPlainCarbon=function(e){return rnd.logMethod("atomIsPlainCarbon"),this.ctab.atoms.get(e).a.isPlainCarbon()},rnd.Render.prototype.highlightObject=function(e,t){if(["atoms","bonds","rxnArrows","rxnPluses","chiralFlags","frags","rgroups","sgroups","sgroupData"].indexOf(e.map)>-1){var n=this.ctab[e.map].get(e.id);if(n==null)return!0;if(e.map=="sgroups"&&n.item.type=="DAT"||e.map=="sgroupData"){var r=this.ctab.sgroups.get(e.id),i=this.ctab.sgroupData.get(e.id);r!=null&&r.setHighlight(t,this),i!=null&&i.setHighlight(t,this)}else n.setHighlight(t,this);return!0}return!1},rnd.Render.prototype.itemGetPos=function(e,t){return this.ctab.molecule[e].get(t).pp},rnd.Render.prototype.atomGetPos=function(e){return rnd.logMethod("atomGetPos"),this.itemGetPos("atoms",e)},rnd.Render.prototype.rxnArrowGetPos=function(e){return rnd.logMethod("rxnArrowGetPos"),this.itemGetPos("rxnArrows",e)},rnd.Render.prototype.rxnPlusGetPos=function(e){return rnd.logMethod("rxnPlusGetPos"),this.itemGetPos("rxnPluses",e)},rnd.Render.prototype.getAdjacentBonds=function(e){var t=util.Set.fromList(e),n=util.Set.empty(),r=util.Set.empty();for(var i=0;i<e.length;++i){var s=e[i],o=this.ctab.atoms.get(s);for(var u=0;u<o.a.neighbors.length;++u){var a=o.a.neighbors[u],f=this.ctab.molecule.halfBonds.get(a),l=f.end,c=util.Set.contains(t,l)?n:r;util.Set.add(c,f.bid)}}return{inner:n,cross:r}},rnd.Render.prototype.bondGetAttr=function(e,t){return rnd.logMethod("bondGetAttr"),this.ctab.bonds.get(e).b[t]},rnd.Render.prototype.setSelection=function(e){rnd.logMethod("setSelection");for(var t in rnd.ReStruct.maps){if(t=="frags"||t=="rgroups")continue;var n=e?e[t]?util.identityMap(e[t]):{}:null;this.ctab[t].each(function(e,t){var r=n?n[e]===e:t.selected;t.selected=r,this.ctab.showItemSelection(e,t,r)},this)}},rnd.Render.prototype.initStyles=function(){var e=this.settings;this.styles={},this.styles.lineattr={stroke:"#000","stroke-width":e.lineWidth,"stroke-linecap":"round","stroke-linejoin":"round"},this.styles.selectionStyle={fill:"#7f7",stroke:"none"},this.styles.selectionZoneStyle={fill:"#000",stroke:"none",opacity:0},this.styles.highlightStyle={stroke:"#0c0","stroke-width":.6*e.lineWidth},this.styles.sGroupHighlightStyle={stroke:"#9900ff","stroke-width":.6*e.lineWidth},this.styles.sgroupBracketStyle={stroke:"darkgray","stroke-width":.5*e.lineWidth},this.styles.atomSelectionPlateRadius=e.labelFontSize*1.2},rnd.Render.prototype.initSettings=function(){var e=this.settings={};e.delta=this.ctab.molecule.getCoordBoundingBox(),e.margin=.1,e.scaleFactor=this.scale,e.lineWidth=e.scaleFactor/20,e.bondShift=e.scaleFactor/6,e.bondSpace=e.scaleFactor/7,e.labelFontSize=Math.ceil(1.9*(e.scaleFactor/6)),e.subFontSize=Math.ceil(.7*e.labelFontSize),e.font='30px "Arial"',e.fontsz=this.settings.labelFontSize,e.fontszsub=this.settings.subFontSize,e.fontRLabel=this.settings.labelFontSize*1.2,e.fontRLogic=this.settings.labelFontSize*.7},rnd.Render.prototype.getBoundingBox=function(){var e=null,t;return this.ctab.eachVisel(function(n){t=n.boundingBox,t&&(e=e?util.Box2Abs.union(e,t):t.clone())},this),e||(e=new util.Box2Abs(0,0,0,0)),e},rnd.Render.prototype.getStructCenter=function(){var e=this.getBoundingBox();return this.scaled2obj(util.Vec2.lc2(e.p0,.5,e.p1,.5))},rnd.Render.prototype.onResize=function(){this.setViewSize(new util.Vec2(this.clientArea.clientWidth,this.clientArea.clientHeight))},rnd.Render.prototype.setViewSize=function(e){this.viewSz=new util.Vec2(e)},rnd.Render.prototype._setPaperSize=function(e){var t=this.zoom;this.paper.setSize(e.x*t,e.y*t),this.setViewBox(t)},rnd.Render.prototype.setPaperSize=function(e){rnd.logMethod("setPaperSize");var t=this.sz;this.sz=e,this._setPaperSize(e),this.onCanvasSizeChanged&&this.onCanvasSizeChanged(e,t)},rnd.Render.prototype.setOffset=function(e){rnd.logMethod("setOffset");var t=this.offset;this.offset=e,this.onCanvasOffsetChanged&&this.onCanvasOffsetChanged(e,t)},rnd.Render.prototype.getElementPos=function(e){var t=0,n=0;if(e.offsetParent)do t+=e.offsetLeft,n+=e.offsetTop;while(e=e.offsetParent);return new util.Vec2(t,n)},rnd.Render.prototype.drawSelectionLine=function(e,t){rnd.logMethod("drawSelectionLine"),this.selectionRect&&(this.selectionRect.remove(),this.selectionRect=null),e&&t&&(e=this.obj2scaled(e).add(this.offset),t=this.obj2scaled(t).add(this.offset),this.selectionRect=this.paper.path("M"+e.x.toString()+","+e.y.toString()+"L"+t.x.toString()+","+t.y.toString()).attr({stroke:"gray","stroke-width":"1px"}))},rnd.Render.prototype.drawSelectionRectangle=function(e,t){rnd.logMethod("drawSelectionRectangle"),this.selectionRect&&(this.selectionRect.remove(),this.selectionRect=null),e&&t&&(e=this.obj2scaled(e).add(this.offset),t=this.obj2scaled(t).add(this.offset),this.selectionRect=this.paper.rect(Math.min(e.x,t.x),Math.min(e.y,t.y),Math.abs(t.x-e.x),Math.abs(t.y-e.y)).attr({stroke:"gray","stroke-width":"1px"}))},rnd.Render.prototype.getElementsInRectangle=function(e,t){rnd.logMethod("getElementsInRectangle");var n=new Array,r=new Array,i=Math.min(e.x,t.x),s=Math.max(e.x,t.x),o=Math.min(e.y,t.y),u=Math.max(e.y,t.y);this.ctab.bonds.each(function(e,t){var r=util.Vec2.lc2(this.ctab.atoms.get(t.b.begin).a.pp,.5,this.ctab.atoms.get(t.b.end).a.pp,.5);r.x>i&&r.x<s&&r.y>o&&r.y<u&&n.push(e)},this),this.ctab.atoms.each(function(e,t){t.a.pp.x>i&&t.a.pp.x<s&&t.a.pp.y>o&&t.a.pp.y<u&&r.push(e)},this);var a=new Array,f=new Array;this.ctab.rxnArrows.each(function(e,t){t.item.pp.x>i&&t.item.pp.x<s&&t.item.pp.y>o&&t.item.pp.y<u&&a.push(e)},this),this.ctab.rxnPluses.each(function(e,t){t.item.pp.x>i&&t.item.pp.x<s&&t.item.pp.y>o&&t.item.pp.y<u&&f.push(e)},this);var l=new Array;this.ctab.chiralFlags.each(function(e,t){t.pp.x>i&&t.pp.x<s&&t.pp.y>o&&t.pp.y<u&&l.push(e)},this);var c=new Array;return this.ctab.sgroupData.each(function(e,t){t.sgroup.pp.x>i&&t.sgroup.pp.x<s&&t.sgroup.pp.y>o&&t.sgroup.pp.y<u&&c.push(e)},this),{atoms:r,bonds:n,rxnArrows:a,rxnPluses:f,chiralFlags:l,sgroupData:c}},rnd.Render.prototype.drawSelectionPolygon=function(e){rnd.logMethod("drawSelectionPolygon"),this.selectionRect&&(this.selectionRect.remove(),this.selectionRect=null);if(e&&e.length>1){var t=this.obj2scaled(e[e.length-1]).add(this.offset),n="M"+t.x.toString()+","+t.y.toString();for(var r=0;r<e.length;++r)t=this.obj2scaled(e[r]).add(this.offset),n+="L"+t.x.toString()+","+t.y.toString();this.selectionRect=this.paper.path(n).attr({stroke:"gray","stroke-width":"1px"})}},rnd.Render.prototype.isPointInPolygon=function(e,t){var n=new util.Vec2(0,1),r=n.rotate(Math.PI/2),i=util.Vec2.diff(e[e.length-1],t),s=util.Vec2.dot(r,i),o=util.Vec2.dot(n,i),u=null,a=0,f=1e-5,l=!1,c=!1;for(var h=0;h<e.length;++h){var p=util.Vec2.diff(e[h],t),d=util.Vec2.diff(p,i),v=util.Vec2.dot(r,p),m=util.Vec2.dot(n,p);l=!1,v*s<0&&(m*o>-f?o>-f&&(l=!0):(Math.abs(s)*Math.abs(m)-Math.abs(v)*Math.abs(o))*m>0&&(l=!0)),l&&c&&util.Vec2.dot(d,r)*util.Vec2(u,r)>=0&&(l=!1),l&&a++,i=p,s=v,o=m,u=d,c=l}return a%2!=0},rnd.Render.prototype.ps=function(e){return e.scaled(this.settings.scaleFactor)},rnd.Render.prototype.getElementsInPolygon=function(e){rnd.logMethod("getElementsInPolygon");var t=new Array,n=new Array,r=[];for(var i=0;i<e.length;++i)r[i]=new util.Vec2(e[i].x,e[i].y);this.ctab.bonds.each(function(e,n){var i=util.Vec2.lc2(this.ctab.atoms.get(n.b.begin).a.pp,.5,this.ctab.atoms.get(n.b.end).a.pp,.5);this.isPointInPolygon(r,i)&&t.push(e)},this),this.ctab.atoms.each(function(e,t){this.isPointInPolygon(r,t.a.pp)&&n.push(e)},this);var s=new Array,o=new Array;this.ctab.rxnArrows.each(function(e,t){this.isPointInPolygon(r,t.item.pp)&&s.push(e)},this),this.ctab.rxnPluses.each(function(e,t){this.isPointInPolygon(r,t.item.pp)&&o.push(e)},this);var u=new Array;this.ctab.chiralFlags.each(function(e,t){this.isPointInPolygon(r,t.pp)&&u.push(e)},this);var a=new Array;return this.ctab.sgroupData.each(function(e,t){this.isPointInPolygon(r,t.sgroup.pp)&&a.push(e)},this),{atoms:n,bonds:t,rxnArrows:s,rxnPluses:o,chiralFlags:u,sgroupData:a}},rnd.Render.prototype.testPolygon=function(e){e=e||[{x:50,y:10},{x:20,y:90},{x:90,y:30},{x:10,y:30},{x:90,y:80}];if(e.length<3)return;var t=e[0],n=e[0];for(var r=1;r<e.length;++r)t=util.Vec2.min(t,e[r]),n=util.Vec2.max(n,e[r]);this.drawSelectionPolygon(e);for(var i=0;i<1e3;++i){var s=new util.Vec2(Math.random()*zz,Math.random()*zz),o=this.isPointInPolygon(e,s),u=o?"#0f0":"#f00";this.paper.circle(s.x,s.y,2).attr({fill:u,stroke:"none"})}this.drawSelectionPolygon(e)},rnd.Render.prototype.processAction=function(e,t){var n=parseInt(t[0]);e=="atomRemove"&&this.curItem.type=="Atom"&&this.curItem.id==n&&this._onAtomMouseOut&&this._onAtomMouseOut({pageX:this.pagePos.x,pageY:this.pagePos.y},this.curItem.id),e=="bondRemove"&&this.curItem.type=="Bond"&&this.curItem.id==n&&this._onBondMouseOut&&this._onBondMouseOut({pageX:this.pagePos.x,pageY:this.pagePos.y},this.curItem.id),e=="rxnArrowRemove"&&this.curItem.type=="RxnArrow"&&this.curItem.id==n&&this._onRxnArrowMouseOut&&this._onRxnArrowMouseOut({pageX:this.pagePos.x,pageY:this.pagePos.y},this.curItem.id),e=="rxnPlusRemove"&&this.curItem.type=="RxnPlus"&&this.curItem.id==n&&this._onRxnPlusMouseOut&&this.onRxnArrowMouseOut({pageX:this.pagePos.x,pageY:this.pagePos.y},this.curItem.id),this.muteMouseOutMouseOver=!0;var r=this["_"+e].apply(this,t);return this.muteMouseOutMouseOver=!1,e.endsWith("Add")&&(this.checkCurItem=!0),r},rnd.Render.prototype.update=function(e){rnd.logMethod("update"),this.muteMouseOutMouseOver=!0;if(!this.settings||this.dirty){if(this.opt.autoScale){var t=this.ctab.molecule.getCoordBoundingBox(),n=t.max.y-t.min.y>0?this.viewSz.y/(t.max.y-t.min.y):100,r=t.max.x-t.min.x>0?this.viewSz.x/(t.max.x-t.min.x):100;this.scale=Math.max(n,r)}this.initSettings(),this.initStyles(),this.dirty=!1,e=!0}var i=(new Date).getTime(),s=this.ctab.update(e);this.setSelection(null);var o=(new Date).getTime()-i;e&&$("log")&&($("log").innerHTML=o.toString()+"\n");if(s){var u=this.settings.scaleFactor,a=this.getBoundingBox();if(!this.opt.autoScale){var f=util.Vec2.UNIT.scaled(u);a=a.extend(f,f);if(this.bb)this.bb=util.Box2Abs.union(this.bb,a);else{var l=this.viewSz.sub(a.sz()).scaled(.5).max(util.Vec2.ZERO);this.bb=a.extend(l,l)}a=this.bb.clone();var c=util.Vec2.max(a.sz().floor(),this.viewSz),h=a.p0.negated().ceil();(!this.sz||c.x>this.sz.x||c.y>this.sz.y)&&this.setPaperSize(c);var p=this.offset||new util.Vec2,d=h.sub(p);if(!this.offset||d.x>0||d.y>0)this.setOffset(h),this.ctab.translate(d),this.bb.translate(d)}else{var v=a.sz(),m=new util.Vec2(this.opt.autoScaleMargin,this.opt.autoScaleMargin),g=this.viewSz.sub(m.scaled(2));if(g.x<1||g.y<1)throw new Error("View box too small for the given margin");var y=Math.min(g.x/v.x,g.y/v.y);this.ctab.scale(y);var b=g.sub(v.scaled(y)).scaled(.5).add(m).sub(a.pos().scaled(y));this.ctab.translate(b)}}this.muteMouseOutMouseOver=!1;if(this.checkCurItem){this.checkCurItem=!1;var w=new rnd.MouseEvent({pageX:this.pagePos.x,pageY:this.pagePos.y});this.checkCurrentItem(w)}},rnd.Render.prototype.checkBondExists=function(e,t){return this.ctab.molecule.checkBondExists(e,t)},rnd.Render.prototype.findClosestAtom=function(e,t,n){var r=null,i=this.opt.selectionDistanceCoefficient;return t=t||i,t=Math.min(t,i),this.ctab.atoms.each(function(i,s){if(i!=n){var o=util.Vec2.dist(e,s.a.pp);o<t&&(r=i,t=o)}},this),r!=null?{id:r,dist:t}:null},rnd.Render.prototype.findClosestBond=function(e,t){var n=null,r=this.opt.selectionDistanceCoefficient;return t=t||r,t=Math.min(t,r),this.ctab.bonds.each(function(r,i){var s=this.ctab.molecule.halfBonds.get(i.b.hb1),o=s.dir,u=s.norm,a=this.ctab.atoms.get(i.b.begin).a.pp,f=this.ctab.atoms.get(i.b.end).a.pp,l=util.Vec2.dot(e.sub(a),o)*util.Vec2.dot(e.sub(f),o)<0;if(l){var c=Math.abs(util.Vec2.dot(e.sub(a),u));c<t&&(n=r,t=c)}},this),n!=null?{id:n,dist:t}:null},rnd.Render.prototype.findClosestItem=function(e,t,n){var r=null,i=function(e,t){t!=null&&(r==null||r.dist>t.dist)&&(r={type:e,id:t.id,dist:t.dist})};if(!t||t.indexOf("atoms")>=0){var s=this.findClosestAtom(e,undefined,!Object.isUndefined(n)&&n.map=="atoms"?n.id:undefined);i("Atom",s)}if(!t||t.indexOf("bonds")>=0){var o=this.findClosestBond(e);(r==null||r.dist>.4*this.scale)&&i("Bond",o)}if(!t||t.indexOf("chiralFlags")>=0){var u=rnd.ReChiralFlag.findClosest(this,e);i("ChiralFlag",u)}if(!t||t.indexOf("sgroupData")>=0){var a=rnd.ReDataSGroupData.findClosest(this,e);i("DataSGroupData",a)}if(!t||t.indexOf("sgroups")>=0){var f=rnd.ReSGroup.findClosest(this,e);i("SGroup",f)}if(!t||t.indexOf("rxnArrows")>=0){var l=rnd.ReRxnArrow.findClosest(this,e);i("RxnArrow",l)}if(!t||t.indexOf("rxnPluses")>=0){var c=rnd.ReRxnPlus.findClosest(this,e);i("RxnPlus",c)}if(!t||t.indexOf("frags")>=0){var h=rnd.ReFrag.findClosest(this,e,n&&n.map=="atoms"?n.id:undefined);i("Fragment",h)}if(!t||t.indexOf("rgroups")>=0){var p=rnd.ReRGroup.findClosest(this,e);i("RGroup",p)}return r=r||{type:"Canvas",id:-1},r},rnd.Render.prototype.addItemPath=function(e,t,n,r){if(!n)return;var i=r?util.Box2Abs.fromRelBox(r):null,s=this.offset;s!=null&&(i!=null&&i.translate(s),n.translate(s.x,s.y)),e.add(n,i),this.ctab.insertInLayer(rnd.ReStruct.layerMap[t],n)},rnd.Render.prototype.setZoom=function(e){this.zoom=e,this._setPaperSize(this.sz)},rnd.Render.prototype.extendCanvas=function(e,t,n,r){var i=0,s=0,o=0,u=0;e-=0,n-=0,t-=0,r-=0,e<0&&(i+=-e,o+=-e),t<0&&(s+=-t,u+=-t);var a=this.sz.x*this.zoom,f=this.sz.y*this.zoom;a<n&&(i+=n-a),f<r&&(s+=r-f);var l=(new util.Vec2(o,u)).scaled(1/this.zoom);if(s>0||i>0){var c=(new util.Vec2(i,s)).scaled(1/this.zoom),h=this.sz.add(c);this.setPaperSize(h);if(l.x>0||l.y>0)this.setOffset(this.offset.add(l)),this.ctab.translate(l),this.bb.translate(l)}return l},rnd.Render.prototype.setScale=function(e){this.offset&&(this.offset=this.offset.scaled(1/e).scaled(this.zoom)),this.scale=this.baseScale*this.zoom,this.settings=null,this.update(!0)},rnd.Render.prototype.setViewBox=function(e){this.useOldZoom?this.setScale(e):this.paper.canvas.setAttribute("viewBox","0 0 "+this.sz.x+" "+this.sz.y)};