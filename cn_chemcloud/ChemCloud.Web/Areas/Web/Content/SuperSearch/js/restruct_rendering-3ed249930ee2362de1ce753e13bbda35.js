/****************************************************************************
 * Copyright (C) 2009-2010 GGA Software Services LLC
 *
 * This file may be distributed and/or modified under the terms of the
 * GNU Affero General Public License version 3 as published by the Free
 * Software Foundation and appearing in the file LICENSE.GPL included in
 * the packaging of this file.
 *
 * This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE
 * WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.
 ***************************************************************************/
if(!window.rnd||!rnd.ReStruct)throw new Error("MolData should be defined first");rnd.relBox=function(e){return{x:e.x,y:e.y,width:e.width,height:e.height}},rnd.ReStruct.prototype.drawArrow=function(e,t){var n=5,r=7,i=this.render.paper,s=this.render.styles;return i.path("M{0},{1}L{2},{3}L{4},{5}M{2},{3}L{4},{6}",e.x,e.y,t.x,t.y,t.x-r,t.y-n,t.y+n).attr(s.lineattr)},rnd.ReStruct.prototype.drawPlus=function(e){var t=this.render.scale/5,n=this.render.paper,r=this.render.styles;return n.path("M{0},{4}L{0},{5}M{2},{1}L{3},{1}",e.x,e.y,e.x-t,e.x+t,e.y-t,e.y+t).attr(r.lineattr)},rnd.ReStruct.prototype.drawBondSingle=function(e,t){var n=e.p,r=t.p,i=this.render.paper,s=this.render.styles;return i.path("M{0},{1}L{2},{3}",n.x,n.y,r.x,r.y).attr(s.lineattr)},rnd.ReStruct.prototype.drawBondSingleUp=function(e,t){var n=e.p,r=t.p,i=e.norm,s=this.render.settings,o=this.render.paper,u=this.render.styles,a=s.bondSpace,f=r.addScaled(i,a),l=r.addScaled(i,-a);return o.path("M{0},{1}L{2},{3}L{4},{5},L{0},{1}",n.x,n.y,f.x,f.y,l.x,l.y).attr(u.lineattr).attr({fill:"#000"})},rnd.ReStruct.prototype.drawBondSingleDown=function(e,t){var n=e.p,r=t.p,i=e.norm,s=this.render.settings,o=this.render.paper,u=this.render.styles,a=s.bondSpace,f=r.sub(n),l=f.length();f=f.normalized();var c=1.2*s.lineWidth,h=Math.floor((l-s.lineWidth)/(s.lineWidth+c))+1,p=l/(h-1),d="",v,m,g=n;for(var y=0;y<h;++y)g=n.addScaled(f,p*y),v=g.addScaled(i,a*y/(h-1)),m=g.addScaled(i,-a*y/(h-1)),d+="M"+v.x+","+v.y+"L"+m.x+","+m.y;return o.path(d).attr(u.lineattr)},rnd.ReStruct.prototype.drawBondSingleEither=function(e,t){var n=e.p,r=t.p,i=e.norm,s=this.render.settings,o=this.render.paper,u=this.render.styles,a=s.bondSpace,f=r.sub(n),l=f.length();f=f.normalized();var c=.6*s.lineWidth,h=Math.floor((l-s.lineWidth)/(s.lineWidth+c))+1,p=l/(h-1),d="M"+n.x+","+n.y,v=n;for(var m=0;m<h;++m)v=n.addScaled(f,p*m).addScaled(i,(m&1?-1:1)*a*m/(h-1)),d+="L"+v.x+","+v.y;return o.path(d).attr(u.lineattr)},rnd.ReStruct.prototype.getBondLineShift=function(e,t){return t<0||Math.abs(e)>.9?0:t/(1-e)},rnd.ReStruct.prototype.drawBondDouble=function(e,t,n,r){var i=e.p,s=t.p,o=e.norm,u=r?0:n.doubleBondShift,a=this.render.settings,f=this.render.paper,l=this.render.styles,c=a.bondSpace/2,h=c,p=-c;h+=u*c,p+=u*c;var d=i.addScaled(o,h),v=s.addScaled(o,h),m=i.addScaled(o,p),g=s.addScaled(o,p),y=!this.atoms.get(e.begin).showLabel,b=!this.atoms.get(t.begin).showLabel;return u>0?(y&&(d=d.addScaled(e.dir,a.bondSpace*this.getBondLineShift(e.rightCos,e.rightSin))),b&&(v=v.addScaled(e.dir,-a.bondSpace*this.getBondLineShift(t.leftCos,t.leftSin)))):u<0&&(y&&(m=m.addScaled(e.dir,a.bondSpace*this.getBondLineShift(e.leftCos,e.leftSin))),b&&(g=g.addScaled(e.dir,-a.bondSpace*this.getBondLineShift(t.rightCos,t.rightSin)))),f.path(r?"M{0},{1}L{6},{7}M{4},{5}L{2},{3}":"M{0},{1}L{2},{3}M{4},{5}L{6},{7}",d.x,d.y,v.x,v.y,m.x,m.y,g.x,g.y).attr(l.lineattr)},rnd.ReStruct.makeStroke=function(e,t){return"M"+e.x.toString()+","+e.y.toString()+"L"+t.x.toString()+","+t.y.toString()+"	"},rnd.ReStruct.prototype.drawBondSingleOrDouble=function(e,t){var n=e.p,r=t.p,i=e.norm,s=this.render,o=s.settings,u=s.paper,a=s.styles,f=o.bondSpace/2,l=(util.Vec2.dist(n,r)/(o.bondSpace+o.lineWidth)).toFixed()-0;l&1||(l+=1);var c="",h=n;for(var p=1;p<=l;++p){var d=util.Vec2.lc2(n,(l-p)/l,r,p/l);p&1?c+=rnd.ReStruct.makeStroke(h,d):(c+=rnd.ReStruct.makeStroke(h.addScaled(i,f),d.addScaled(i,f)),c+=rnd.ReStruct.makeStroke(h.addScaled(i,-f),d.addScaled(i,-f))),h=d}return u.path(c).attr(a.lineattr)},rnd.ReStruct.prototype.drawBondTriple=function(e,t){var n=e.p,r=t.p,i=e.norm,s=this.render,o=s.settings,u=s.paper,a=s.styles,f=n.addScaled(i,o.bondSpace),l=r.addScaled(i,o.bondSpace),c=n.addScaled(i,-o.bondSpace),h=r.addScaled(i,-o.bondSpace),p=!this.atoms.get(e.begin).showLabel,d=!this.atoms.get(t.begin).showLabel;return p&&(f=f.addScaled(e.dir,o.bondSpace*this.getBondLineShift(e.rightCos,e.rightSin))),d&&(l=l.addScaled(e.dir,-o.bondSpace*this.getBondLineShift(t.leftCos,t.leftSin))),p&&(c=c.addScaled(e.dir,o.bondSpace*this.getBondLineShift(e.leftCos,e.leftSin))),d&&(h=h.addScaled(e.dir,-o.bondSpace*this.getBondLineShift(t.rightCos,t.rightSin))),u.path("M{0},{1}L{2},{3}M{4},{5}L{6},{7}M{8},{9}L{10},{11}",n.x,n.y,r.x,r.y,f.x,f.y,l.x,l.y,c.x,c.y,h.x,h.y).attr(a.lineattr)},rnd.ReStruct.prototype.drawBondAromatic=function(e,t,n,r){if(!r)return this.drawBondSingle(e,t);var i=n.doubleBondShift,s=this.render.paper,o=this.preparePathsForAromaticBond(e,t,i),u=o[0],a=o[1];return(i>0?u:a).attr({"stroke-dasharray":"- "}),s.set([u,a])},rnd.ReStruct.prototype.drawBondSingleOrAromatic=function(e,t,n){var r=n.doubleBondShift,i=this.render.paper,s=this.preparePathsForAromaticBond(e,t,r),o=s[0],u=s[1];return(r>0?o:u).attr({"stroke-dasharray":"-."}),i.set([o,u])},rnd.ReStruct.prototype.preparePathsForAromaticBond=function(e,t,n){var r=this.render.settings,i=this.render.paper,s=this.render.styles,o=e.p,u=t.p,a=e.norm,f=r.bondSpace/2,l=f,c=-f;l+=n*f,c+=n*f;var h=o.addScaled(a,l),p=u.addScaled(a,l),d=o.addScaled(a,c),v=u.addScaled(a,c),m=!this.atoms.get(e.begin).showLabel,g=!this.atoms.get(t.begin).showLabel;n>0?(m&&(h=h.addScaled(e.dir,r.bondSpace*this.getBondLineShift(e.rightCos,e.rightSin))),g&&(p=p.addScaled(e.dir,-r.bondSpace*this.getBondLineShift(t.leftCos,t.leftSin)))):n<0&&(m&&(d=d.addScaled(e.dir,r.bondSpace*this.getBondLineShift(e.leftCos,e.leftSin))),g&&(v=v.addScaled(e.dir,-r.bondSpace*this.getBondLineShift(t.rightCos,t.rightSin))));var y=i.path("M{0},{1}L{2},{3}",h.x,h.y,p.x,p.y).attr(s.lineattr),b=i.path("M{0},{1}L{2},{3}",d.x,d.y,v.x,v.y).attr(s.lineattr);return[y,b]},rnd.ReStruct.prototype.drawBondDoubleOrAromatic=function(e,t,n){var r=n.doubleBondShift,i=this.render.paper,s=this.preparePathsForAromaticBond(e,t,r),o=s[0],u=s[1];return o.attr({"stroke-dasharray":"-."}),u.attr({"stroke-dasharray":"-."}),i.set([o,u])},rnd.ReStruct.prototype.drawBondAny=function(e,t){var n=e.p,r=t.p,i=this.render.paper,s=this.render.styles;return i.path("M{0},{1}L{2},{3}",n.x,n.y,r.x,r.y).attr(s.lineattr).attr({"stroke-dasharray":"- "})},rnd.ReStruct.prototype.drawReactingCenter=function(e,t,n){var r=t.p,i=n.p,s=i.add(r).scaled(.5),o=i.sub(r).normalized(),u=o.rotateSC(1,0),a=this.render.paper,f=this.render.styles,l=this.render.settings,c=[],h=l.lineWidth,p=l.bondSpace/2,d=h,v=2*h,m=1.5*p,g=1.5*p,y=3*p,b=.2;switch(e.b.reactingCenterStatus){case chem.Struct.BOND.REACTING_CENTER.NOT_CENTER:c.push(s.addScaled(u,y).addScaled(o,b*y)),c.push(s.addScaled(u,-y).addScaled(o,-b*y)),c.push(s.addScaled(u,y).addScaled(o,-b*y)),c.push(s.addScaled(u,-y).addScaled(o,b*y));break;case chem.Struct.BOND.REACTING_CENTER.CENTER:c.push(s.addScaled(u,y).addScaled(o,b*y).addScaled(o,d)),c.push(s.addScaled(u,-y).addScaled(o,-b*y).addScaled(o,d)),c.push(s.addScaled(u,y).addScaled(o,b*y).addScaled(o,-d)),c.push(s.addScaled(u,-y).addScaled(o,-b*y).addScaled(o,-d)),c.push(s.addScaled(o,m).addScaled(u,g)),c.push(s.addScaled(o,-m).addScaled(u,g)),c.push(s.addScaled(o,m).addScaled(u,-g)),c.push(s.addScaled(o,-m).addScaled(u,-g));break;case chem.Struct.BOND.REACTING_CENTER.MADE_OR_BROKEN:c.push(s.addScaled(u,y).addScaled(o,v)),c.push(s.addScaled(u,-y).addScaled(o,v)),c.push(s.addScaled(u,y).addScaled(o,-v)),c.push(s.addScaled(u,-y).addScaled(o,-v));break;case chem.Struct.BOND.REACTING_CENTER.ORDER_CHANGED:c.push(s.addScaled(u,y)),c.push(s.addScaled(u,-y));break;case chem.Struct.BOND.REACTING_CENTER.MADE_OR_BROKEN_AND_CHANGED:c.push(s.addScaled(u,y).addScaled(o,v)),c.push(s.addScaled(u,-y).addScaled(o,v)),c.push(s.addScaled(u,y).addScaled(o,-v)),c.push(s.addScaled(u,-y).addScaled(o,-v)),c.push(s.addScaled(u,y)),c.push(s.addScaled(u,-y));break;default:return null}var w="";for(var E=0;E<c.length/2;++E)w+="M"+c[2*E].x+","+c[2*E].y+"L"+c[2*E+1].x+","+c[2*E+1].y;return a.path(w).attr(f.lineattr)},rnd.ReStruct.prototype.drawTopologyMark=function(e,t,n){var r=null;if(e.b.topology==chem.Struct.BOND.TOPOLOGY.RING)r="rng";else{if(e.b.topology!=chem.Struct.BOND.TOPOLOGY.CHAIN)return null;r="chn"}var i=this.render.paper,s=this.render.settings,o=t.p,u=n.p,a=u.add(o).scaled(.5),f=u.sub(o).normalized(),l=f.rotateSC(1,0),c=s.lineWidth;e.doubleBondShift>0?l=l.scaled(-e.doubleBondShift):e.doubleBondShift==0&&(c+=s.bondSpace/2);var h=(new util.Vec2(2,1)).scaled(s.bondSpace);e.b.type==chem.Struct.BOND.TYPE.TRIPLE&&(c+=s.bondSpace);var p=a.add(new util.Vec2(l.x*(h.x+c),l.y*(h.y+c))),d=i.text(p.x,p.y,r).attr({font:s.font,"font-size":s.fontszsub,fill:"#000"}),v=rnd.relBox(d.getBBox());return this.centerText(d,v),d},rnd.ReStruct.prototype.drawBond=function(e,t,n){var r=null,i=this.molecule;switch(e.b.type){case chem.Struct.BOND.TYPE.SINGLE:switch(e.b.stereo){case chem.Struct.BOND.STEREO.UP:r=this.drawBondSingleUp(t,n,e);break;case chem.Struct.BOND.STEREO.DOWN:r=this.drawBondSingleDown(t,n,e);break;case chem.Struct.BOND.STEREO.EITHER:r=this.drawBondSingleEither(t,n,e);break;default:r=this.drawBondSingle(t,n)}break;case chem.Struct.BOND.TYPE.DOUBLE:r=this.drawBondDouble(t,n,e,e.b.stereo==chem.Struct.BOND.STEREO.CIS_TRANS);break;case chem.Struct.BOND.TYPE.TRIPLE:r=this.drawBondTriple(t,n,e);break;case chem.Struct.BOND.TYPE.AROMATIC:var s=t.loop>=0&&i.loops.get(t.loop).aromatic||n.loop>=0&&i.loops.get(n.loop).aromatic;r=this.drawBondAromatic(t,n,e,!s);break;case chem.Struct.BOND.TYPE.SINGLE_OR_DOUBLE:r=this.drawBondSingleOrDouble(t,n,e);break;case chem.Struct.BOND.TYPE.SINGLE_OR_AROMATIC:r=this.drawBondSingleOrAromatic(t,n,e);break;case chem.Struct.BOND.TYPE.DOUBLE_OR_AROMATIC:r=this.drawBondDoubleOrAromatic(t,n,e);break;case chem.Struct.BOND.TYPE.ANY:r=this.drawBondAny(t,n,e);break;default:throw new Error("Bond type "+e.b.type+" not supported")}return r},rnd.ReStruct.prototype.radicalCap=function(e){var t=this.render.settings,n=this.render.paper,r=t.lineWidth*.9,i=r,s=2*r;return n.path("M{0},{1}L{2},{3}L{4},{5}",e.x-i,e.y+s,e.x,e.y,e.x+i,e.y+s).attr({stroke:"#000","stroke-width":t.lineWidth*.7,"stroke-linecap":"square","stroke-linejoin":"miter"})},rnd.ReStruct.prototype.radicalBullet=function(e){var t=this.render.settings,n=this.render.paper;return n.circle(e.x,e.y,t.lineWidth).attr({stroke:null,fill:"#000"})},rnd.ReStruct.prototype.centerText=function(e,t){this.render.paper.raphael.vml&&this.pathAndRBoxTranslate(e,t,0,t.height*.16)},rnd.ReStruct.prototype.showAtomHighlighting=function(e,t,n){var r=t.highlighting!=null&&!t.highlighting.removed;r=r&&(!("hiddenPaths"in rnd.ReStruct.prototype)||rnd.ReStruct.prototype.hiddenPaths.indexOf(t.highlighting)<0);if(n){if(!r){var i=this.render,s=i.styles,o=i.paper,u=i.ps(t.a.pp);t.highlighting=o.circle(u.x,u.y,s.atomSelectionPlateRadius).attr(s.highlightStyle),rnd.DEBUG&&t.highlighting.attr({fill:"#AAA"}),i.addItemPath(t.visel,"highlighting",t.highlighting)}rnd.DEBUG?t.highlighting.attr({stroke:"#0c0"}):t.highlighting.show()}else r&&(rnd.DEBUG?t.highlighting.attr({stroke:"none"}):t.highlighting.hide())},rnd.ReStruct.prototype.showItemSelection=function(e,t,n){var r=t.selectionPlate!=null&&!t.selectionPlate.removed;r=r&&(!("hiddenPaths"in rnd.ReStruct.prototype)||rnd.ReStruct.prototype.hiddenPaths.indexOf(t.selectionPlate)<0);if(n){if(!r){var i=this.render,s=i.styles,o=i.paper;t.selectionPlate=t.makeSelectionPlate(this,o,s),i.addItemPath(t.visel,"selection-plate",t.selectionPlate)}t.selectionPlate&&t.selectionPlate.show()}else r&&t.selectionPlate&&t.selectionPlate.hide()},rnd.ReStruct.prototype.pathAndRBoxTranslate=function(e,t,n,r){e.translate(n,r),t.x+=n,t.y+=r};var markerColors=["black","cyan","magenta","red","green","blue","green"];rnd.ReStruct.prototype.showLabels=function(){var e=this.render,t=e.settings,n=e.styles,r=e.opt,i=e.paper,s=.5*t.lineWidth;for(var o in this.atomsChanged){var u=this.atoms.get(o),a=e.ps(u.a.pp),f=null;r.showAtomIds&&(f={},f.text=o.toString(),f.path=i.text(a.x,a.y,f.text).attr({font:t.font,"font-size":t.fontszsub,fill:"#070"}),f.rbb=rnd.relBox(f.path.getBBox()),this.centerText(f.path,f.rbb),e.addItemPath(u.visel,"indices",f.path,f.rbb)),u.highlight&&this.showAtomHighlighting(o,u,!0);var l="#000000";if(u.showLabel){var h=0,p=0,d={};if(u.a.atomList!=null)d.text=u.a.atomList.label();else if(u.a.label=="R#"&&u.a.rglabel!=null){d.text="";for(var v=0;v<32;v++)u.a.rglabel&1<<v&&(d.text+="R"+(v+1).toString());d.text==""&&(d="R#")}else{d.text=u.a.label;if(r.atomColoring){var m=chem.Element.getElementByLabel(d.text);m&&(l=chem.Element.elements.get(m).color)}}d.path=i.text(a.x,a.y,d.text).attr({font:t.font,"font-size":t.fontsz,fill:l}),d.rbb=rnd.relBox(d.path.getBBox()),this.centerText(d.path,d.rbb),u.a.atomList!=null&&this.pathAndRBoxTranslate(d.path,d.rbb,(u.hydrogenOnTheLeft?-1:1)*(d.rbb.width-d.rbb.height)/2,0),e.addItemPath(u.visel,"data",d.path,d.rbb),h=d.rbb.width/2,p=-d.rbb.width/2;var g=Math.floor(u.a.implicitH),y=d.text=="H",b={},w=null,E=u.hydrogenOnTheLeft;y&&g>0&&(w={},w.text=(g+1).toString(),w.path=i.text(a.x,a.y,w.text).attr({font:t.font,"font-size":t.fontszsub,fill:l}),w.rbb=rnd.relBox(w.path.getBBox()),this.centerText(w.path,w.rbb),this.pathAndRBoxTranslate(w.path,w.rbb,h+.5*w.rbb.width+s,.2*d.rbb.height),h+=w.rbb.width+s,e.addItemPath(u.visel,"data",w.path,w.rbb));var S={};if(u.a.radical!=0){var x;switch(u.a.radical){case 1:S.path=i.set(),x=1.6*t.lineWidth,S.path.push(this.radicalBullet(a).translate(-x,0),this.radicalBullet(a).translate(x,0)),S.path.attr("fill",l);break;case 2:S.path=this.radicalBullet(a).attr("fill",l);break;case 3:S.path=i.set(),x=1.6*t.lineWidth,S.path.push(this.radicalCap(a).translate(-x,0),this.radicalCap(a).translate(x,0)),S.path.attr("stroke",l)}S.rbb=rnd.relBox(S.path.getBBox());var T=-0.5*(d.rbb.height+S.rbb.height);u.a.radical==3&&(T-=t.lineWidth/2),this.pathAndRBoxTranslate(S.path,S.rbb,0,T),e.addItemPath(u.visel,"data",S.path,S.rbb)}var N={};u.a.isotope!=0&&(N.text=u.a.isotope.toString(),N.path=i.text(a.x,a.y,N.text).attr({font:t.font,"font-size":t.fontszsub,fill:l}),N.rbb=rnd.relBox(N.path.getBBox()),this.centerText(N.path,N.rbb),this.pathAndRBoxTranslate(N.path,N.rbb,p-.5*N.rbb.width-s,-0.3*d.rbb.height),p-=N.rbb.width+s,e.addItemPath(u.visel,"data",N.path,N.rbb)),!y&&g>0&&!e.opt.hideImplicitHydrogen&&(b.text="H",b.path=i.text(a.x,a.y,b.text).attr({font:t.font,"font-size":t.fontsz,fill:l}),b.rbb=rnd.relBox(b.path.getBBox()),this.centerText(b.path,b.rbb),E||(this.pathAndRBoxTranslate(b.path,b.rbb,h+.5*b.rbb.width+s,0),h+=b.rbb.width+s),g>1&&(w={},w.text=g.toString(),w.path=i.text(a.x,a.y,w.text).attr({font:t.font,"font-size":t.fontszsub,fill:l}),w.rbb=rnd.relBox(w.path.getBBox()),this.centerText(w.path,w.rbb),E||(this.pathAndRBoxTranslate(w.path,w.rbb,h+.5*w.rbb.width+s,.2*d.rbb.height),h+=w.rbb.width+s)),E&&(w!=null&&(this.pathAndRBoxTranslate(w.path,w.rbb,p-.5*w.rbb.width-s,.2*d.rbb.height),p-=w.rbb.width+s),this.pathAndRBoxTranslate(b.path,b.rbb,p-.5*b.rbb.width-s,0),p-=b.rbb.width+s),e.addItemPath(u.visel,"data",b.path,b.rbb),w!=null&&e.addItemPath(u.visel,"data",w.path,w.rbb));var C={};if(u.a.charge!=0){C.text="";var k=Math.abs(u.a.charge);k!=1&&(C.text=k.toString()),u.a.charge<0?C.text+="–":C.text+="+",C.path=i.text(a.x,a.y,C.text).attr({font:t.font,"font-size":t.fontszsub,fill:l}),C.rbb=rnd.relBox(C.path.getBBox()),this.centerText(C.path,C.rbb),this.pathAndRBoxTranslate(C.path,C.rbb,h+.5*C.rbb.width+s,-0.3*d.rbb.height),h+=C.rbb.width+s,e.addItemPath(u.visel,"data",C.path,C.rbb)}var L={},A={0:"0",1:"I",2:"II",3:"III",4:"IV",5:"V",6:"VI",7:"VII",8:"VIII",9:"IX",10:"X",11:"XI",12:"XII",13:"XIII",14:"XIV"};if(u.a.explicitValence){L.text=A[u.a.valence];if(!L.text)throw new Error("invalid valence "+u.a.valence.toString());L.text="("+L.text+")",L.path=i.text(a.x,a.y,L.text).attr({font:t.font,"font-size":t.fontszsub,fill:l}),L.rbb=rnd.relBox(L.path.getBBox()),this.centerText(L.path,L.rbb),this.pathAndRBoxTranslate(L.path,L.rbb,h+.5*L.rbb.width+s,-0.3*d.rbb.height),h+=L.rbb.width+s,e.addItemPath(u.visel,"data",L.path,L.rbb)}if(u.a.badConn&&r.showValenceWarnings){var O={},M=a.y+d.rbb.height/2+s;O.path=i.path("M{0},{1}L{2},{3}",a.x+p,M,a.x+h,M).attr(this.render.styles.lineattr).attr({stroke:"#F00"}),O.rbb=rnd.relBox(O.path.getBBox()),e.addItemPath(u.visel,"warnings",O.path,O.rbb)}f&&this.pathAndRBoxTranslate(f.path,f.rbb,-0.5*d.rbb.width-.5*f.rbb.width-s,.3*d.rbb.height)}var _=this.bisectLargestSector(u),D=Prototype.Browser.IE?"*":"∗";if(u.a.attpnt){var P,H;for(P=0,c=0;P<4;++P){var B="";if(u.a.attpnt&1<<P){B.length>0&&(B+=" "),B+=D;for(H=0;H<(P==0?0:P+1);++H)B+="'";var j=new util.Vec2(a),F=a.addScaled(_,.7*t.scaleFactor),I=i.text(F.x,F.y,B).attr({font:t.font,"font-size":t.fontsz,fill:l}),q=rnd.relBox(I.getBBox());this.centerText(I,q);var R=_.negated();F=F.addScaled(R,util.Vec2.shiftRayBox(F,R,util.Box2Abs.fromRelBox(q))+t.lineWidth/2),j=this.shiftBondEnd(u,j,_,t.lineWidth);var U=_.rotateSC(1,0),z=F.addScaled(U,.05*t.scaleFactor).addScaled(R,.09*t.scaleFactor),W=F.addScaled(U,-0.05*t.scaleFactor).addScaled(R,.09*t.scaleFactor),X=i.set();X.push(I,i.path("M{0},{1}L{2},{3}M{4},{5}L{2},{3}L{6},{7}",j.x,j.y,F.x,F.y,z.x,z.y,W.x,W.y).attr(n.lineattr).attr({"stroke-width":t.lineWidth/2})),e.addItemPath(u.visel,"indices",X,q),_=_.rotate(Math.PI/6)}}}var V="";u.a.aam>0&&(V+=u.a.aam);if(u.a.invRet>0){V.length>0&&(V+=",");if(u.a.invRet==1)V+="Inv";else{if(u.a.invRet!=2)throw new Error("Invalid value for the invert/retain flag");V+="Ret"}}var $="";if(u.a.ringBondCount!=0)if(u.a.ringBondCount>0)$+="rb"+u.a.ringBondCount.toString();else if(u.a.ringBondCount==-1)$+="rb0";else{if(u.a.ringBondCount!=-2)throw new Error("Ring bond count invalid");$+="rb*"}if(u.a.substitutionCount!=0){$.length>0&&($+=",");if(u.a.substitutionCount>0)$+="s"+u.a.substitutionCount.toString();else if(u.a.substitutionCount==-1)$+="s0";else{if(u.a.substitutionCount!=-2)throw new Error("Substitution count invalid");$+="s*"}}if(u.a.unsaturatedAtom>0){$.length>0&&($+=",");if(u.a.unsaturatedAtom!=1)throw new Error("Unsaturated atom invalid value");$+="u"}u.a.hCount>0&&($.length>0&&($+=","),$+="H"+(u.a.hCount-1).toString());if($.length>0){var J=i.text(a.x,a.y,$).attr({font:t.font,"font-size":t.fontszsub,fill:l}),K=rnd.relBox(J.getBBox());this.centerText(J,K),this.pathAndRBoxTranslate(J,K,0,t.scaleFactor/3),e.addItemPath(u.visel,"indices",J,K)}if(u.a.exactChangeFlag>0){V.length>0&&(V+=",");if(u.a.exactChangeFlag!=1)throw new Error("Invalid value for the exact change flag");V+="ext"}if(V.length>0){var Q=i.text(a.x,a.y,"."+V+".").attr({font:t.font,"font-size":t.fontszsub,fill:l}),G=rnd.relBox(Q.getBBox());this.centerText(Q,G);var Y=this.bisectLargestSector(u),Z=u.visel,et=3;for(P=0;P<Z.boxes.length;++P)et=Math.max(et,util.Vec2.shiftRayBox(a,Y,Z.boxes[P]));Y=Y.scaled(10+et),this.pathAndRBoxTranslate(Q,G,Y.x,Y.y),e.addItemPath(u.visel,"data",Q,null)}}},rnd.ReStruct.prototype.shiftBondEnd=function(e,t,n,r){var i=0,s=e.visel;for(var o=0;o<s.boxes.length;++o)i=Math.max(i,util.Vec2.shiftRayBox(t,n,s.boxes[o]));return i>0&&(t=t.addScaled(n,i+r)),t},rnd.ReStruct.prototype.bisectLargestSector=function(e){var t=[];e.a.neighbors.each(function(e){var n=this.molecule.halfBonds.get(e);t.push(n.ang)},this),t=t.sort(function(e,t){return e-t});var n=[];for(var r=0;r<t.length-1;++r)n.push(t[(r+1)%t.length]-t[r]);n.push(t[0]-t[t.length-1]+2*Math.PI);var i=0,s=-Math.PI/2;for(r=0;r<t.length;++r)n[r]>i&&(i=n[r],s=t[r]+n[r]/2);return new util.Vec2(Math.cos(s),Math.sin(s))},rnd.ReStruct.prototype.showBondHighlighting=function(e,t,n){var r=t.highlighting!=null&&!t.highlighting.removed;r=r&&(!("hiddenPaths"in rnd.ReStruct.prototype)||rnd.ReStruct.prototype.hiddenPaths.indexOf(t.highlighting)<0);if(n){if(!r){var i=this.render,s=i.styles,o=i.paper;this.bondRecalc(i.settings,t),t.highlighting=o.ellipse(t.b.center.x,t.b.center.y,t.b.sa,t.b.sb).rotate(t.b.angle).attr(s.highlightStyle),rnd.DEBUG&&t.highlighting.attr({fill:"#AAA"}),i.addItemPath(t.visel,"highlighting",t.highlighting)}rnd.DEBUG?t.highlighting.attr({stroke:"#0c0"}):t.highlighting.show()}else r&&(rnd.DEBUG?t.highlighting.attr({stroke:"none"}):t.highlighting.hide())},rnd.ReStruct.prototype.bondRecalc=function(e,t){var n=this.render,r=n.ps(this.atoms.get(t.b.begin).a.pp),i=n.ps(this.atoms.get(t.b.end).a.pp),s=this.molecule.halfBonds.get(t.b.hb1);t.b.center=util.Vec2.lc2(r,.5,i,.5),t.b.len=util.Vec2.dist(r,i),t.b.sb=e.lineWidth*5,t.b.sa=Math.max(t.b.sb,t.b.len/2-e.lineWidth*2),t.b.angle=Math.atan2(s.dir.y,s.dir.x)*180/Math.PI},rnd.ReStruct.prototype.showBonds=function(){var e=this.render,t=e.settings,n=e.paper,r=e.opt;for(var i in this.bondsChanged){var s=this.bonds.get(i),o=this.molecule.halfBonds.get(s.b.hb1),u=this.molecule.halfBonds.get(s.b.hb2);this.bondRecalc(t,s),s.path=this.drawBond(s,o,u),s.rbb=rnd.relBox(s.path.getBBox()),e.addItemPath(s.visel,"data",s.path,s.rbb);var a={};a.path=this.drawReactingCenter(s,o,u),a.path&&(a.rbb=rnd.relBox(a.path.getBBox()),e.addItemPath(s.visel,"data",a.path,a.rbb));var f={};f.path=this.drawTopologyMark(s,o,u),f.path&&(f.rbb=rnd.relBox(f.path.getBBox()),e.addItemPath(s.visel,"data",f.path,f.rbb)),s.highlight&&this.showBondHighlighting(i,s,!0);var l=t.subFontSize*.6,c=null,h=null;if(r.showBondIds){var p=util.Vec2.lc(o.p,.5,u.p,.5,o.norm,l);c=n.text(p.x,p.y,i.toString()),h=rnd.relBox(c.getBBox()),this.centerText(c,h),e.addItemPath(s.visel,"indices",c,h);var d=util.Vec2.lc(o.p,.8,u.p,.2,o.norm,l);c=n.text(d.x,d.y,s.b.hb1.toString()),h=rnd.relBox(c.getBBox()),this.centerText(c,h),e.addItemPath(s.visel,"indices",c,h);var v=util.Vec2.lc(o.p,.2,u.p,.8,o.norm,l);c=n.text(v.x,v.y,s.b.hb2.toString()),h=rnd.relBox(c.getBBox()),this.centerText(c,h),e.addItemPath(s.visel,"indices",c,h)}else if(r.showLoopIds){var m=util.Vec2.lc(o.p,.5,u.p,.5,u.norm,l);c=n.text(m.x,m.y,o.loop.toString()),h=rnd.relBox(c.getBBox()),this.centerText(c,h),e.addItemPath(s.visel,"indices",c,h);var g=util.Vec2.lc(o.p,.5,u.p,.5,o.norm,l);c=n.text(g.x,g.y,u.loop.toString()),h=rnd.relBox(c.getBBox()),this.centerText(c,h),e.addItemPath(s.visel,"indices",c,h)}}},rnd.ReStruct.prototype.labelIsVisible=function(e,t){if(t.a.neighbors.length<2&&!this.render.opt.hideTerminalLabels||t.a.label==null||t.a.label.toLowerCase()!="c"||t.a.badConn&&this.render.opt.showValenceWarnings||t.a.isotope!=0||t.a.radical!=0||t.a.charge!=0||t.a.explicitValence||t.a.atomList!=null||t.a.rglabel!=null)return!0;if(!t.showLabel&&t.a.neighbors.length==2){var n=t.a.neighbors[0],r=t.a.neighbors[1],i=this.molecule.halfBonds.get(n),s=this.molecule.halfBonds.get(r),o=this.bonds.get(i.bid),u=this.bonds.get(s.bid);if(o.b.type==u.b.type&&o.b.stereo==chem.Struct.BOND.STEREO.NONE&&u.b.stereo==chem.Struct.BOND.STEREO.NONE&&Math.abs(util.Vec2.cross(i.dir,s.dir))<.05)return!0}return!1},rnd.ReStruct.prototype.checkLabelsToShow=function(){for(var e in this.atomsChanged){var t=this.atoms.get(e);t.showLabel=this.labelIsVisible(e,t)}},rnd.ReStruct.layerMap={background:0,"selection-plate":1,highlighting:2,warnings:3,data:4,indices:5},rnd.ReStruct.prototype.addReObjectPath=function(e,t,n){var r=this.render.offset,i=util.Box2Abs.fromRelBox(rnd.relBox(n.getBBox()));r!=null&&n.translate(r.x,r.y),t.add(n,i),this.insertInLayer(rnd.ReStruct.layerMap[e],n)},rnd.ReStruct.prototype.addTmpPath=function(e,t){var n=new rnd.Visel("TMP"),r=this.render.offset;r!=null&&t.translate(r.x,r.y),n.add(t),this.tmpVisels.push(n),this.insertInLayer(rnd.ReStruct.layerMap[e],t)},rnd.ReStruct.prototype.clearVisel=function(e){for(var t=0;t<e.paths.length;++t)e.paths[t].remove();e.clear()},rnd.ReStruct.prototype.shiftBonds=function(){var e=this.render,t=e.settings;for(var n in this.atomsChanged){var r=this.atoms.get(n);r.a.neighbors.each(function(n){var i=this.molecule.halfBonds.get(n),s=e.ps(r.a.pp);i.p=this.shiftBondEnd(r,s,i.dir,2*t.lineWidth)},this)}},rnd.ReStruct.prototype.selectDoubleBondShift=function(e,t,n,r){return e==6&&t!=6&&(n>1||r==1)?-1:t==6&&e!=6&&(r>1||n==1)?1:t*n>e*r?-1:t*n<e*r?1:t>e?-1:1},rnd.ReStruct.prototype.selectDoubleBondShift_Chain=function(e){var t=this.molecule,n=t.halfBonds.get(e.b.hb1),r=t.halfBonds.get(e.b.hb2),i=(n.leftSin>.3?1:0)+(r.rightSin>.3?1:0),s=(r.leftSin>.3?1:0)+(n.rightSin>.3?1:0);return i>s?-1:i<s?1:(n.leftSin>.3?1:0)+(n.rightSin>.3?1:0)==1?1:0},rnd.ReStruct.prototype.setDoubleBondShift=function(){var e=this.molecule;for(var t in this.bondsChanged){var n=this.bonds.get(t),r,i;r=e.halfBonds.get(n.b.hb1).loop,i=e.halfBonds.get(n.b.hb2).loop;if(r>=0&&i>=0){var s=e.loops.get(r).dblBonds,o=e.loops.get(i).dblBonds,u=e.loops.get(r).hbs.length,a=e.loops.get(i).hbs.length;n.doubleBondShift=this.selectDoubleBondShift(u,a,s,o)}else r>=0?n.doubleBondShift=-1:i>=0?n.doubleBondShift=1:n.doubleBondShift=this.selectDoubleBondShift_Chain(n)}},rnd.ReStruct.prototype.updateLoops=function(){this.reloops.each(function(e,t){this.clearVisel(t.visel)},this),this.findLoops()},rnd.ReStruct.prototype.renderLoops=function(){var e=this.render,t=e.settings,n=e.paper,r=this.molecule;this.reloops.each(function(i,s){var o=s.loop;s.centre=new util.Vec2,o.hbs.each(function(t){var n=r.halfBonds.get(t),i=this.bonds.get(n.bid),u=e.ps(this.atoms.get(n.begin).a.pp);i.b.type!=chem.Struct.BOND.TYPE.AROMATIC&&(o.aromatic=!1),s.centre.add_(u)},this),o.convex=!0;for(var u=0;u<s.loop.hbs.length;++u){var a=r.halfBonds.get(o.hbs[u]),f=r.halfBonds.get(o.hbs[(u+1)%o.hbs.length]),l=Math.atan2(util.Vec2.cross(a.dir,f.dir),util.Vec2.dot(a.dir,f.dir));l>0&&(o.convex=!1)}s.centre=s.centre.scaled(1/o.hbs.length),s.radius=-1,o.hbs.each(function(t){var n=r.halfBonds.get(t),i=e.ps(this.atoms.get(n.begin).a.pp),o=e.ps(this.atoms.get(n.end).a.pp),u=util.Vec2.diff(o,i).rotateSC(1,0).normalized(),a=util.Vec2.dot(util.Vec2.diff(i,s.centre),u);s.radius<0?s.radius=a:s.radius=Math.min(s.radius,a)},this),s.radius*=.7;if(!o.aromatic)return;var c=null;if(o.convex)c=n.circle(s.centre.x,s.centre.y,s.radius).attr({stroke:"#000","stroke-width":t.lineWidth});else{var h="";for(u=0;u<o.hbs.length;++u){a=r.halfBonds.get(o.hbs[u]),f=r.halfBonds.get(o.hbs[(u+1)%o.hbs.length]),l=Math.atan2(util.Vec2.cross(a.dir,f.dir),util.Vec2.dot(a.dir,f.dir));var p=(Math.PI-l)/2,d=f.dir.rotate(p),v=e.ps(this.atoms.get(f.begin).a.pp),m=Math.sin(p),g=.1;Math.abs(m)<g&&(m=m*g/Math.abs(m));var y=t.bondSpace/m,b=v.addScaled(d,-y);h+=u==0?"M":"L",h+=b.x.toString()+","+b.y.toString()}h+="Z",c=n.path(h).attr({stroke:"#000","stroke-width":t.lineWidth,"stroke-dasharray":"- "})}this.addReObjectPath("data",s.visel,c)},this)};