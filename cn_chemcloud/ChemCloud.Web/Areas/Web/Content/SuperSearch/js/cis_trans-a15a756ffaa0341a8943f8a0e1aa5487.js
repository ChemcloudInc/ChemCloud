/****************************************************************************
 * Copyright (C) 2009-2010 GGA Software Services LLC
 * 
 * This file may be distributed and/or modified under the terms of the
 * GNU Affero General Public License version 3 as published by the Free
 * Software Foundation and appearing in the file LICENSE.GPL included in
 * the packaging of this file.
 * 
 * This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE
 * WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.
 ***************************************************************************/
if(!window.chem||!chem.Struct)throw new Error("Vec2 and Molecule should be defined first");chem.CisTrans=function(e,t,n){this.molecule=e,this.bonds=new util.Map,this.getNeighbors=t,this.context=n},chem.CisTrans.PARITY={NONE:0,CIS:1,TRANS:2},chem.CisTrans.prototype.each=function(e,t){this.bonds.each(e,t)},chem.CisTrans.prototype.getParity=function(e){return this.bonds.get(e).parity},chem.CisTrans.prototype.getSubstituents=function(e){return this.bonds.get(e).substituents},chem.CisTrans.prototype.sameside=function(e,t,n,r){var i=util.Vec2.diff(e,t),s=new util.Vec2(-i.y,i.x);if(!s.normalize())return 0;var o=util.Vec2.diff(n,e),u=util.Vec2.diff(r,t);if(!o.normalize())return 0;if(!u.normalize())return 0;var a=util.Vec2.dot(o,s),f=util.Vec2.dot(u,s);return Math.abs(a)<.001||Math.abs(f)<.001?0:a*f>0?1:-1},chem.CisTrans.prototype._sameside=function(e,t,n,r){return this.sameside(this.molecule.atoms.get(e).pp,this.molecule.atoms.get(t).pp,this.molecule.atoms.get(n).pp,this.molecule.atoms.get(r).pp)},chem.CisTrans.prototype._sortSubstituents=function(e){var t=this.molecule.atoms.get(e[0]).pureHydrogen(),n=e[1]<0||this.molecule.atoms.get(e[1]).pureHydrogen(),r=this.molecule.atoms.get(e[2]).pureHydrogen(),i=e[3]<0||this.molecule.atoms.get(e[3]).pureHydrogen();return t&&n?!1:r&&i?!1:(n?e[1]=-1:t?(e[0]=e[1],e[1]=-1):e[0]>e[1]&&e.swap(0,1),i?e[3]=-1:r?(e[2]=e[3],e[3]=-1):e[2]>e[3]&&e.swap(2,3),!0)},chem.CisTrans.prototype.isGeomStereoBond=function(e,t){var n=this.molecule.bonds.get(e);if(n.type!=chem.Struct.BOND.TYPE.DOUBLE)return!1;var r=this.molecule.atoms.get(n.begin).label,i=this.molecule.atoms.get(n.end).label;if(r!="C"&&r!="N"&&r!="Si"&&r!="Ge")return!1;if(i!="C"&&i!="N"&&i!="Si"&&i!="Ge")return!1;var s=this.getNeighbors.call(this.context,n.begin),o=this.getNeighbors.call(this.context,n.end);if(s.length<2||s.length>3||o.length<2||o.length>3)return!1;t[0]=-1,t[1]=-1,t[2]=-1,t[3]=-1;var u,a;for(u=0;u<s.length;u++){a=s[u];if(a.bid==e)continue;if(this.molecule.bonds.get(a.bid).type!=chem.Struct.BOND.TYPE.SINGLE)return!1;t[0]==-1?t[0]=a.aid:t[1]=a.aid}for(u=0;u<o.length;u++){a=o[u];if(a.bid==e)continue;if(this.molecule.bonds.get(a.bid).type!=chem.Struct.BOND.TYPE.SINGLE)return!1;t[2]==-1?t[2]=a.aid:t[3]=a.aid}return t[1]!=-1&&this._sameside(n.begin,n.end,t[0],t[1])!=-1?!1:t[3]!=-1&&this._sameside(n.begin,n.end,t[2],t[3])!=-1?!1:!0},chem.CisTrans.prototype.build=function(e){this.molecule.bonds.each(function(t,n){var r=this.bonds.set(t,{parity:0,substituents:new Array(4)});if(Object.isArray(e)&&e[t])return;if(!this.isGeomStereoBond(t,r.substituents))return;if(!this._sortSubstituents(r.substituents))return;var i=this._sameside(n.begin,n.end,r.substituents[0],r.substituents[2]);i==1?r.parity=chem.CisTrans.PARITY.CIS:i==-1&&(r.parity=chem.CisTrans.PARITY.TRANS)},this)};