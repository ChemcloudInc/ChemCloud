/****************************************************************************
 * Copyright (C) 2009-2010 GGA Software Services LLC
 *
 * This file may be distributed and/or modified under the terms of the
 * GNU Affero General Public License version 3 as published by the Free
 * Software Foundation and appearing in the file LICENSE.GPL included in
 * the packaging of this file.
 *
 * This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE
 * WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.
 ***************************************************************************/
typeof ui=="undefined"&&(ui=function(){}),ui.standalone=!0,ui.path="/",ui.base_url="",ui.scale=40,ui.zoomValues=[.1,.2,.3,.4,.5,.6,.7,.8,.9,1,1.5,2,2.5,3,3.5,4],ui.zoomIdx=ui.zoomValues.indexOf(1),ui.zoom=1,ui.DBLCLICK_INTERVAL=300,ui.HISTORY_LENGTH=8,ui.DEBUG=!1,ui.render=null,ui.ctab=new chem.Struct,ui.client_area=null,ui.mode_id=null,ui.undoStack=new Array,ui.redoStack=new Array,ui.is_osx=!1,ui.is_touch=!1,ui.initialized=!1,ui.MODE={SIMPLE:1,ERASE:2,ATOM:3,BOND:4,PATTERN:5,SGROUP:6,PASTE:7,CHARGE:8,RXN_ARROW:9,RXN_PLUS:10,CHAIN:11},ui.initButton=function(e){e.observe(EventMap.mousedown,function(e){if(this.hasClassName("buttonDisabled"))return;this.addClassName("buttonPressed"),ui.hideBlurredControls(),util.stopEventPropagation(e)}),e.observe(EventMap.mouseup,function(){this.removeClassName("buttonPressed")}),e.observe("mouseover",function(){if(this.hasClassName("buttonDisabled"))return;this.addClassName("buttonHighlight");var e=this.getAttribute("title");e!=null&&(window.status=e)}),e.observe("mouseout",function(){this.removeClassName("buttonPressed"),this.removeClassName("buttonHighlight"),window.status=""})},ui.onClick_SideButton=function(){if(this.hasClassName("buttonDisabled"))return;this.hasClassName("stateButton")&&this.hasClassName("buttonSelected")?ui.toggleDropdownList(this.id+"_dropdown"):ui.selectMode(this.getAttribute("selid")||this.id)},ui.onClick_DropdownButton=function(){if(this.hasClassName("buttonDisabled"))return;ui.toggleDropdownList(this.id)},ui.onMouseDown_DropdownListItem=function(e){ui.selectMode(this.id);var t=this.id.split("_")[0];$(t+"_dropdown_list").hide(),ui.mode_id==this.id&&($(t).getAttribute("src")?$(t).setAttribute("src",this.select("img")[0].getAttribute("src")):ketcher.showMolfileOpts(t,ketcher.templates[ui.mode_id],20,{autoScale:!0,autoScaleMargin:4,hideImplicitHydrogen:!0,hideTerminalLabels:!0,ignoreMouseEvents:!0}),$(t).title=this.title,$(t).setAttribute("selid",ui.mode_id));if(e)return util.stopEventPropagation(e),util.preventDefault(e)},ui.defaultSelector="selector_lasso",ui.init=function(){if(this.initialized){this.Action.fromNewCanvas(new chem.Struct),this.render.update(),this.undoStack.clear(),this.redoStack.clear(),this.updateActionButtons(),this.selectMode(ui.defaultSelector);return}this.is_osx=navigator.userAgent.indexOf("Mac OS X")!=-1,this.is_touch="ontouchstart"in document,Prototype.Browser.IE&&($$(".chemicalText").each(function(e){e.addClassName("chemicalText_IE")}),navigator.userAgent.indexOf("MSIE 6.0")!=-1&&$$(".dialogWindow").each(function(e){e.style.width="300px"})),ui.is_osx&&$$(".toolButton, .toolButton > img, .sideButton").each(function(e){e.title=e.title.replace("Ctrl","Cmd")},this),ui.is_touch&&(EventMap={mousemove:"touchmove",mousedown:"touchstart",mouseup:"touchend"},$("output_mol").removeAttribute("readonly"),rnd.ReStruct.prototype.hiddenPaths=[],rnd.ReStruct.prototype.clearVisel=function(e){for(var t=0;t<e.paths.length;++t)e.paths[t].hide(),this.hiddenPaths.push(e.paths[t]);e.clear()}),document.observe("keypress",ui.onKeyPress_Ketcher),document.observe("keydown",ui.onKeyDown_IE),document.observe("keyup",ui.onKeyUp),document.observe(EventMap.mousedown,ui.onMouseDown_Ketcher),document.observe(EventMap.mouseup,ui.onMouseUp_Ketcher),$$(".toolButton").each(ui.initButton),$$(".modeButton").each(function(e){ui.initButton(e),e.identify()!="atom_table"&&e.identify()!="atom_reagenerics"&&e.observe("click",ui.onClick_SideButton)}),$$(".dropdownButton").each(function(e){e.observe("click",ui.onClick_DropdownButton)}),$$(".dropdownListItem").each(function(e){e.observe(EventMap.mousedown,ui.onMouseDown_DropdownListItem),e.observe("mouseover",function(){this.addClassName("highlightedItem")}),e.observe("mouseout",function(){this.removeClassName("highlightedItem")})}),$("new").observe("click",ui.onClick_NewFile),$("open").observe("click",ui.onClick_OpenFile),$("save").observe("click",ui.onClick_SaveFile),$("undo").observe("click",ui.onClick_Undo),$("redo").observe("click",ui.onClick_Redo),$("cut").observe("click",ui.onClick_Cut),$("copy").observe("click",ui.onClick_Copy),$("paste").observe("click",ui.onClick_Paste),$("zoom_in").observe("click",ui.onClick_ZoomIn),$("zoom_out").observe("click",ui.onClick_ZoomOut),$("clean_up").observe("click",ui.onClick_CleanUp),$("aromatize").observe("click",ui.onClick_Aromatize),$("dearomatize").observe("click",ui.onClick_Dearomatize),$("atom_table").observe("click",ui.onClick_ElemTableButton),$("elem_table_list").observe("click",ui.onSelect_ElemTableNotList),$("elem_table_notlist").observe("click",ui.onSelect_ElemTableNotList),$("atom_reagenerics").observe("click",ui.onClick_ReaGenericsTableButton),this.client_area=$("client_area"),this.client_area.observe("scroll",ui.onScroll_ClientArea),$$(".dialogWindow").each(function(e){e.observe("keypress",ui.onKeyPress_Dialog),e.observe("keyup",ui.onKeyUp)}),$("atom_label").observe("change",ui.onChange_AtomLabel),$("atom_charge").observe("change",ui.onChange_AtomCharge),$("atom_isotope").observe("change",ui.onChange_AtomIsotope),$("atom_valence").observe("change",ui.onChange_AtomValence),$("atom_prop_cancel").observe("click",function(){ui.hideDialog("atom_properties")}),$("atom_prop_ok").observe("click",function(){ui.applyAtomProperties()}),$("bond_prop_cancel").observe("click",function(){ui.hideDialog("bond_properties")}),$("bond_prop_ok").observe("click",function(){ui.applyBondProperties()}),$("sgroup_type").observe("change",ui.onChange_SGroupType),$("sgroup_label").observe("change",ui.onChange_SGroupLabel),$("input_label").observe("blur",function(){this.hide()}),$("input_label").observe("keypress",ui.onKeyPress_InputLabel),$("input_label").observe("keyup",ui.onKeyUp),$("elem_table_cancel").observe("click",function(){ui.elem_table_obj.restore(),ui.hideDialog("elem_table")}),$("elem_table_ok").observe("click",function(e){ui.hideDialog("elem_table"),ui.onClick_SideButton.apply($("atom_table"),[e])}),$("radio_open_from_input").observe("click",ui.onSelect_OpenFromInput),$("radio_open_from_file").observe("click",ui.onSelect_OpenFromFile),$("input_mol").observe("keyup",ui.onChange_Input),$("input_mol").observe("click",ui.onChange_Input),$("read_cancel").observe("click",function(){ui.hideDialog("open_file")}),$("read_ok").observe("click",function(){ui.loadMoleculeFromInput()}),$("upload_mol").observe("submit",function(){ui.hideDialog("open_file")}),$("upload_cancel").observe("click",function(){ui.hideDialog("open_file")}),$("file_format").observe("change",ui.onChange_FileFormat),$("save_ok").observe("click",function(){ui.hideDialog("save_file")}),ui.onResize_Ketcher(),Prototype.Browser.IE&&(ui.client_area.absolutize(),$("ketcher_window").observe("resize",ui.onResize_Ketcher)),ui.path=document.location.pathname.substring(0,document.location.pathname.lastIndexOf("/")+1),ui.base_url=document.location.href.substring(0,document.location.href.lastIndexOf("/")+1),this.standalone?($$(".serverRequired").each(function(e){e.hasClassName("toolButton")?e.addClassName("buttonDisabled"):e.hide()}),document.title+=" (standalone)"):ui.path!="/"&&($("upload_mol").action=ui.base_url+"open",$("download_mol").action=ui.base_url+"save"),this.render=new rnd.Render(this.client_area,ui.scale,{atomColoring:!0}),this.editor=new rnd.Editor(this.render),this.selectMode("selector_lasso"),this.render.onCanvasOffsetChanged=this.onOffsetChanged,this.render.setMolecule(this.ctab),this.render.update(),this.initialized=!0},ui.showDialog=function(e){$("window_cover").style.width=$("ketcher_window").getWidth().toString()+"px",$("window_cover").style.height=$("ketcher_window").getHeight().toString()+"px",$("window_cover").show(),$(e).show()},ui.hideDialog=function(e){$(e).hide(),$("window_cover").hide(),$("window_cover").style.width="0px",$("window_cover").style.height="0px"},ui.toggleDropdownList=function(e){var t=e+"_list";if($(t).visible())$(t).hide();else{$(t).show();if($(t).hasClassName("renderFirst")){var n={autoScale:!0,autoScaleMargin:4,hideImplicitHydrogen:!0,hideTerminalLabels:!0};$(t).select("tr").each(function(e){$(e.id+"_preview")&&ketcher.showMolfileOpts(e.id+"_preview",ketcher.templates[e.id],20,n)}),$(t).removeClassName("renderFirst")}}},ui.onResize_Ketcher=function(){Prototype.Browser.IE&&(ui.client_area.style.width=(Element.getWidth(ui.client_area.parentNode)-2).toString()+"px"),ui.client_area.style.height=(Element.getHeight(ui.client_area.parentNode)-2).toString()+"px"},ui.updateMolecule=function(e){if(typeof e=="undefined"||e==null)return;ui.selected()&&ui.updateSelection(),this.addUndoAction(this.Action.fromNewCanvas(e)),ui.showDialog("loading"),setTimeout(function(){try{ui.render.onResize(),ui.render.update(),ui.setZoomCentered(null,ui.render.getStructCenter())}catch(e){alert(e.message)}finally{ui.hideDialog("loading")}},50)},ui.parseCTFile=function(e,t){var n=e.split("\n");n.length>0&&n[0]=="Ok."&&n.shift();try{try{return chem.Molfile.parseCTFile(n)}catch(r){if(t){try{return chem.Molfile.parseCTFile(n.slice(1))}catch(i){}try{return chem.Molfile.parseCTFile([""].concat(n))}catch(s){}}throw r}}catch(o){return alert("Error loading molfile.\n"+o.toString()),null}},ui.selectMode=function(e){if(e=="reaction_automap"){ui.showAutomapProperties({onOk:function(e){var t=(new chem.MolfileSaver).saveMolecule(ui.ctab,!0);new Ajax.Request(ui.path+"automap",{method:"post",asynchronous:!0,parameters:{moldata:t,mode:e},onComplete:function(e){e.responseText.startsWith("Ok.")&&ui.updateMolecule(ui.parseCTFile(e.responseText))}})}});return}if(e!=null){if($(e).hasClassName("buttonDisabled"))return;if(ui.selected()){if(e=="select_erase"){ui.removeSelected();return}if(e.startsWith("atom_")){ui.addUndoAction(ui.Action.fromSelectedAtomsAttrs(ui.atomLabel(e)),!0),ui.render.update();return}}}if(this.mode_id!=null&&this.mode_id!=e){var t=this.mode_id.split("_")[0],n=$(t)&&$(t).hasClassName("stateButton")||!1;n?e&&!e.startsWith(t)&&$(t).removeClassName("buttonSelected"):$(this.mode_id).removeClassName("buttonSelected")}this.editor.deselectAll(),this.render.current_tool&&this.render.current_tool.OnCancel(),e==null?(this.mode_id=null,delete this.render.current_tool):(this.render.current_tool=this.editor.toolFor(e),this.mode_id=e,t=this.mode_id.split("_")[0],n=$(t)&&$(t).hasClassName("stateButton")||!1,n?$(t).addClassName("buttonSelected"):$(this.mode_id).addClassName("buttonSelected"))},ui.bondTypeMap={single:{type:1,stereo:chem.Struct.BOND.STEREO.NONE},up:{type:1,stereo:chem.Struct.BOND.STEREO.UP},down:{type:1,stereo:chem.Struct.BOND.STEREO.DOWN},updown:{type:1,stereo:chem.Struct.BOND.STEREO.EITHER},"double":{type:2,stereo:chem.Struct.BOND.STEREO.NONE},crossed:{type:2,stereo:chem.Struct.BOND.STEREO.CIS_TRANS},triple:{type:3,stereo:chem.Struct.BOND.STEREO.NONE},aromatic:{type:4,stereo:chem.Struct.BOND.STEREO.NONE},singledouble:{type:5,stereo:chem.Struct.BOND.STEREO.NONE},singlearomatic:{type:6,stereo:chem.Struct.BOND.STEREO.NONE},doublearomatic:{type:7,stereo:chem.Struct.BOND.STEREO.NONE},any:{type:8,stereo:chem.Struct.BOND.STEREO.NONE}},ui.bondType=function(e){var t;return Object.isUndefined(e)?t=ui.mode_id.substr(5):t=e.substr(5),ui.bondTypeMap[t]},ui.atomLabel=function(e){var t;return Object.isUndefined(e)?t=ui.mode_id.substr(5):t=e.substr(5),t=="table"?ui.elem_table_obj.getAtomProps():t=="reagenerics"?ui.reagenerics_table_obj.getAtomProps():t=="any"?{label:"A"}:{label:t.capitalize()}},ui.onClick_NewFile=function(){if(this.hasClassName("buttonDisabled"))return;ui.selectMode(ui.defaultSelector),ui.ctab.isBlank()||(ui.addUndoAction(ui.Action.fromNewCanvas(new chem.Struct)),ui.render.update())},ui.onKeyPress_Ketcher=function(e){util.stopEventPropagation(e);if($("window_cover").visible())return util.preventDefault(e);if(ui&&ui.render.current_tool&&ui.render.current_tool.processEvent("OnKeyPress",e))return util.preventDefault(e);switch(Prototype.Browser.IE?e.keyCode:e.which){case 43:case 61:return ui.onClick_ZoomIn.call($("zoom_in")),util.preventDefault(e);case 45:case 95:return ui.onClick_ZoomOut.call($("zoom_out")),util.preventDefault(e);case 8:return ui.is_osx&&ui.selected()&&ui.removeSelected(),util.preventDefault(e);case 48:return ui.onMouseDown_DropdownListItem.call($("bond_any")),util.preventDefault(e);case 49:var t=["bond_single","bond_up","bond_down","bond_updown"];return ui.onMouseDown_DropdownListItem.call($(t[(t.indexOf(ui.mode_id)+1)%t.length])),util.preventDefault(e);case 50:var n=["bond_double","bond_crossed"];return ui.onMouseDown_DropdownListItem.call($(n[(n.indexOf(ui.mode_id)+1)%n.length])),util.preventDefault(e);case 51:return ui.onMouseDown_DropdownListItem.call($("bond_triple")),util.preventDefault(e);case 52:return ui.onMouseDown_DropdownListItem.call($("bond_aromatic")),util.preventDefault(e);case 53:var r=["charge_plus","charge_minus"];return ui.selectMode(r[(r.indexOf(ui.mode_id)+1)%r.length]),util.preventDefault(e);case 66:return ui.selectMode("atom_br"),util.preventDefault(e);case 67:return ui.selectMode("atom_cl"),util.preventDefault(e);case 82:return ui.selectMode("rgroup"),util.preventDefault(e);case 90:return(e.metaKey&&ui.is_osx||e.ctrlKey&&!ui.is_osx)&&ui.onClick_Redo.call($("redo")),util.preventDefault(e);case 97:return e.metaKey&&ui.is_osx||e.ctrlKey&&!ui.is_osx?ui.selectAll():ui.selectMode("atom_any"),util.preventDefault(e);case 99:return e.altKey||(e.metaKey&&ui.is_osx||e.ctrlKey&&!ui.is_osx?ui.onClick_Copy.call($("copy")):e.metaKey||ui.selectMode("atom_c")),util.preventDefault(e);case 102:return ui.selectMode("atom_f"),util.preventDefault(e);case 103:return(e.metaKey&&ui.is_osx||e.ctrlKey&&!ui.is_osx)&&ui.onClick_SideButton.call($("sgroup")),util.preventDefault(e);case 104:return ui.selectMode("atom_h"),util.preventDefault(e);case 105:return ui.selectMode("atom_i"),util.preventDefault(e);case 108:return(e.metaKey&&ui.is_osx||e.ctrlKey&&!ui.is_osx)&&ui.onClick_CleanUp.call($("clean_up")),util.preventDefault(e);case 110:return e.metaKey&&ui.is_osx||e.ctrlKey&&!ui.is_osx?ui.onClick_NewFile.call($("new")):ui.selectMode("atom_n"),util.preventDefault(e);case 111:return e.metaKey&&ui.is_osx||e.ctrlKey&&!ui.is_osx?ui.onClick_OpenFile.call($("open")):ui.selectMode("atom_o"),util.preventDefault(e);case 112:return ui.selectMode("atom_p"),util.preventDefault(e);case 115:return e.metaKey&&ui.is_osx||e.ctrlKey&&!ui.is_osx?ui.onClick_SaveFile.call($("save")):ui.selectMode("atom_s"),util.preventDefault(e);case 116:if(ui.mode_id.startsWith("template_")){var i=rnd.Editor.TemplateTool.prototype.templates;ui.onMouseDown_DropdownListItem.apply({id:"template_"+(parseInt(ui.mode_id.split("_")[1])+1)%i.length})}else ui.onMouseDown_DropdownListItem.apply({id:$("template").getAttribute("selid")});return util.preventDefault(e);case 118:return(e.metaKey&&ui.is_osx||e.ctrlKey&&!ui.is_osx)&&ui.onClick_Paste.call($("paste")),util.preventDefault(e);case 120:return(e.metaKey&&ui.is_osx||e.ctrlKey&&!ui.is_osx)&&ui.onClick_Cut.call($("cut")),util.preventDefault(e);case 122:if(e.metaKey&&ui.is_osx||e.ctrlKey&&!ui.is_osx)e.shiftKey?ui.onClick_Redo.call($("redo")):ui.onClick_Undo.call($("undo"));return util.preventDefault(e);case 126:return ui.render.update(!0),util.preventDefault(e)}},ui.ctrlShortcuts=[65,67,71,76,78,79,83,86,88,90],ui.onKeyDown_IE=function(e){if($("window_cover").visible())return!0;if(Prototype.Browser.Gecko&&e.which==46)return util.stopEventPropagation(e),util.preventDefault(e);if(Prototype.Browser.WebKit&&(e.metaKey&&ui.is_osx||e.ctrlKey&&!ui.is_osx)&&ui.ctrlShortcuts.indexOf(e.which)!=-1)return util.stopEventPropagation(e),util.preventDefault(e);if(!Prototype.Browser.IE)return;if(ui.ctrlShortcuts.indexOf(e.keyCode)!=-1&&e.ctrlKey)return util.stopEventPropagation(e),util.preventDefault(e)},ui.onKeyUp=function(e){if(e.keyCode==27)return this==document||!this.visible()?$("window_cover").visible()||ui.selectMode(ui.defaultSelector):this.hasClassName("dialogWindow")?ui.hideDialog(this.id):this.hide(),util.stopEventPropagation(e),util.preventDefault(e);if($("window_cover").visible())return!0;if(e.keyCode==46)return ui.selected()&&ui.removeSelected(),util.stopEventPropagation(e),util.preventDefault(e);if(!Prototype.Browser.WebKit&&!Prototype.Browser.IE)return;if((!Prototype.Browser.WebKit||!(e.metaKey&&ui.is_osx||e.ctrlKey&&!ui.is_osx)||ui.ctrlShortcuts.indexOf(e.which)==-1)&&e.keyCode!=46&&Prototype.Browser.WebKit)return;if(this!=document)return;util.stopEventPropagation(e);switch(e.keyCode){case 46:ui.selected()&&ui.removeSelected();return;case 65:(e.metaKey&&ui.is_osx||e.ctrlKey&&!ui.is_osx)&&ui.selectAll();return;case 67:(e.metaKey&&ui.is_osx||e.ctrlKey&&!ui.is_osx)&&ui.onClick_Copy.call($("copy"));return;case 71:(e.metaKey&&ui.is_osx||e.ctrlKey&&!ui.is_osx)&&ui.onClick_SideButton.call($("sgroup"));return;case 76:(e.metaKey&&ui.is_osx||e.ctrlKey&&!ui.is_osx)&&ui.onClick_CleanUp.call($("clean_up"));return;case 78:(e.metaKey&&ui.is_osx||e.ctrlKey&&!ui.is_osx)&&ui.onClick_NewFile.call($("new"));return;case 79:(e.metaKey&&ui.is_osx||e.ctrlKey&&!ui.is_osx)&&ui.onClick_OpenFile.call($("open"));return;case 83:(e.metaKey&&ui.is_osx||e.ctrlKey&&!ui.is_osx)&&ui.onClick_SaveFile.call($("save"));return;case 86:(e.metaKey&&ui.is_osx||e.ctrlKey&&!ui.is_osx)&&ui.onClick_Paste.call($("paste"));return;case 88:(e.metaKey&&ui.is_osx||e.ctrlKey&&!ui.is_osx)&&ui.onClick_Cut.call($("cut"));return;case 90:if(e.metaKey&&ui.is_osx||e.ctrlKey&&!ui.is_osx)e.shiftKey?ui.onClick_Redo.call($("redo")):ui.onClick_Undo.call($("undo"));return}},ui.onKeyPress_Dialog=function(e){util.stopEventPropagation(e);if(e.keyCode==27)return ui.hideDialog(this.id),util.preventDefault(e)},ui.onKeyPress_InputLabel=function(e){util.stopEventPropagation(e);if(e.keyCode==13){this.hide();var t="",n=0,r=this.value.toArray();if(this.value=="*")t="A";else if(this.value.match(/^[*][1-9]?[+-]$/i))t="A",this.value.length==2?n=1:n=parseInt(r[1]),r[2]=="-"&&(n*=-1);else if(this.value.match(/^[A-Z]{1,2}$/i))t=this.value.capitalize();else if(this.value.match(/^[A-Z]{1,2}[0][+-]?$/i))this.value.match(/^[A-Z]{2}/i)?t=this.value.substr(0,2).capitalize():t=r[0].capitalize();else if(this.value.match(/^[A-Z]{1,2}[1-9]?[+-]$/i)){this.value.match(/^[A-Z]{2}/i)?t=this.value.substr(0,2).capitalize():t=r[0].capitalize();var i=this.value.match(/[0-9]/i);i!=null?n=parseInt(i[0]):n=1,r[this.value.length-1]=="-"&&(n*=-1)}if(t=="A"||t=="Q"||t=="X"||t=="R"||chem.Element.getElementByLabel(t)!=null)ui.addUndoAction(ui.Action.fromAtomAttrs(this.atom_id,{label:t,charge:n}),!0),ui.render.update();return util.preventDefault(e)}if(e.keyCode==27)return this.hide(),util.preventDefault(e)},ui.onClick_OpenFile=function(){if(this.hasClassName("buttonDisabled"))return;ui.showDialog("open_file"),$("radio_open_from_input").checked=!0,$("checkbox_open_copy").checked=!1,ui.onSelect_OpenFromInput()},ui.getFile=function(){var e;return"contentDocument"in $("buffer_frame")?e=$("buffer_frame").contentDocument.body:e=document.frames.buffer_frame.document.body,Base64.decode(e.title)},ui.loadMolecule=function(e,t,n,r){var i=e.strip(),s=r?function(e){e.rescale(),ui.copy(e),ui.updateSelection(),ui.selectMode("paste")}:ui.updateMolecule;if(i.indexOf("\n")==-1){if(ui.standalone){i!=""&&alert("SMILES is not supported in a standalone mode.");return}new Ajax.Request(ui.path+"layout?smiles="+encodeURIComponent(i),{method:"get",asynchronous:!0,onComplete:function(e){if(e.responseText.startsWith("Ok."))s.call(ui,ui.parseCTFile(e.responseText));else{if(!e.responseText.startsWith("Error."))throw new Error("Something went wrong"+e.responseText);alert(e.responseText.split("\n")[1])}}})}else!ui.standalone&&t?new Ajax.Request(ui.path+"layout",{method:"post",asynchronous:!0,parameters:{moldata:e},onComplete:function(e){if(e.responseText.startsWith("Ok."))s.call(ui,ui.parseCTFile(e.responseText));else{if(!e.responseText.startsWith("Error."))throw new Error("Something went wrong"+e.responseText);alert(e.responseText.split("\n")[1])}}}):s.call(ui,ui.parseCTFile(e,n))},ui.dearomatizeMolecule=function(e,t){if(!!ui.standalone)throw new Error("Aromatization and dearomatization are not supported in the standalone mode.");new Ajax.Request(ui.path+(t?"aromatize":"dearomatize"),{method:"post",asynchronous:!0,parameters:{moldata:e},onComplete:function(e){if(e.responseText.startsWith("Ok."))ui.updateMolecule(ui.parseCTFile(e.responseText));else{if(!e.responseText.startsWith("Error."))throw new Error("Something went wrong"+e.responseText);alert(e.responseText.split("\n")[1])}}})},ui.loadMoleculeFromFile=function(){var e=ui.getFile();e.startsWith("Ok.")&&ui.loadMolecule(e.substr(e.indexOf("\n")+1),!1,!1,$("checkbox_open_copy").checked)},ui.loadMoleculeFromInput=function(){ui.hideDialog("open_file"),ui.loadMolecule($("input_mol").value,!1,!0,$("checkbox_open_copy").checked)},ui.onSelect_OpenFromInput=function(){$("open_from_input").show(),$("open_from_file").hide(),ui.onChange_Input.call($("input_mol")),$("input_mol").activate()},ui.onSelect_OpenFromFile=function(){$("open_from_file").show(),$("open_from_input").hide(),$("molfile_path").focus()},ui.onChange_Input=function(){var e=this;setTimeout(function(){e.value.strip().indexOf("\n")!=-1?e.style.wordWrap!="normal"&&(e.style.wordWrap="normal"):e.style.wordWrap!="break-word"&&(e.style.wordWrap="break-word")},200)},ui.onClick_SaveFile=function(){if(this.hasClassName("buttonDisabled"))return;ui.showDialog("save_file"),ui.onChange_FileFormat(null,!0)},ui.onChange_FileFormat=function(e,t){var n=$("output_mol"),r=$("file_format");if(t){var i=new chem.MolfileSaver;n.molfile=i.saveMolecule(ui.ctab,!0);try{i=new chem.SmilesSaver,n.smiles=i.saveMolecule(ui.ctab,!0)}catch(s){n.smiles=s.message}}r.value=="mol"?(n.value=n.molfile,n.style.wordWrap="normal"):(n.value=n.smiles,n.style.wordWrap="break-word"),$("mol_data").value=r.value+"\n"+n.value,n.activate()},ui.onClick_ZoomIn=function(){if(this.hasClassName("buttonDisabled"))return;ui.zoomIdx++,ui.zoomIdx>=ui.zoomValues.length-1&&this.addClassName("buttonDisabled"),$("zoom_out").removeClassName("buttonDisabled");if(ui.zoomIdx<0||ui.zoomIdx>=ui.zoomValues.length)throw new Error("Zoom index out of range");ui.setZoomCentered(ui.zoomValues[ui.zoomIdx],ui.render.view2obj(ui.render.viewSz.scaled(.5))),ui.render.update()},ui.onClick_ZoomOut=function(){if(this.hasClassName("buttonDisabled"))return;ui.zoomIdx--,ui.zoomIdx<=0&&this.addClassName("buttonDisabled"),$("zoom_in").removeClassName("buttonDisabled");if(ui.zoomIdx<0||ui.zoomIdx>=ui.zoomValues.length)throw new Error("Zoom index out of range");ui.setZoomCentered(ui.zoomValues[ui.zoomIdx],ui.render.view2obj(ui.render.viewSz.scaled(.5))),ui.render.update()},ui.setZoomRegular=function(e){if(e<.1||e>10)return;ui.zoom=e,ui.render.setZoom(ui.zoom)},ui.getViewSz=function(){return new util.Vec2(ui.render.viewSz)},ui.setZoomCentered=function(e,t){if(!t)throw new Error("Center point not specified");e&&ui.setZoomRegular(e),ui.setScrollOffset(0,0);var n=ui.render.obj2view(t).sub(ui.render.viewSz.scaled(.5));ui.setScrollOffset(n.x,n.y)},ui.setZoomStaticPointInit=function(e){ui.zspObj=new util.Vec2(e)},ui.setZoomStaticPoint=function(e,t){ui.setZoomRegular(e),ui.setScrollOffset(0,0);var n=ui.render.obj2view(ui.zspObj),r=n.sub(t);ui.setScrollOffset(r.x,r.y)},ui.setScrollOffset=function(e,t){var n=ui.client_area.clientWidth,r=ui.client_area.clientHeight;ui.render.extendCanvas(e,t,n+e,r+t),ui.client_area.scrollLeft=e,ui.client_area.scrollTop=t,ui.scrollLeft=ui.client_area.scrollLeft,ui.scrollTop=ui.client_area.scrollTop},ui.setScrollOffsetRel=function(e,t){ui.setScrollOffset(ui.client_area.scrollLeft+e,ui.client_area.scrollTop+t)},ui.onClick_CleanUp=function(){if(this.hasClassName("buttonDisabled"))return;var e=new chem.MolfileSaver;try{ui.loadMolecule(e.saveMolecule(ui.ctab),!0)}catch(t){alert("Molfile: "+t.message)}},ui.onClick_Aromatize=function(){if(this.hasClassName("buttonDisabled"))return;var e=new chem.MolfileSaver;try{ui.dearomatizeMolecule(e.saveMolecule(ui.ctab),!0)}catch(t){alert("Molfile: "+t.message)}},ui.onClick_Dearomatize=function(){if(this.hasClassName("buttonDisabled"))return;var e=new chem.MolfileSaver;try{ui.dearomatizeMolecule(e.saveMolecule(ui.ctab),!1)}catch(t){alert("Molfile: "+t.message)}},ui.selection={atoms:[],bonds:[],rxnArrows:[],rxnPluses:[],chiralFlags:[]},ui.page2canvas2=function(e){var t=ui.client_area.cumulativeOffset();return new util.Vec2(e.pageX-t.left,e.pageY-t.top)},ui.page2obj=function(e){return ui.render.view2obj(ui.page2canvas2(e))},ui.scrollPos=function(){return new util.Vec2(ui.client_area.scrollLeft,ui.client_area.scrollTop)},ui.scrollLeft=null,ui.scrollTop=null,ui.onScroll_ClientArea=function(e){$("input_label").visible()&&$("input_label").hide(),ui.scrollLeft=ui.client_area.scrollLeft,ui.scrollTop=ui.client_area.scrollTop,util.stopEventPropagation(e)},ui.dbl_click=!1,ui.bondFlipRequired=function(e,t){return t.type==chem.Struct.BOND.TYPE.SINGLE&&e.stereo==chem.Struct.BOND.STEREO.NONE&&t.stereo!=chem.Struct.BOND.STEREO.NONE&&ui.ctab.atoms.get(e.begin).neighbors.length<ui.ctab.atoms.get(e.end).neighbors.length},ui.atomForNewBond=function(e){var t=new Array,n=ui.render.atomGetPos(e);ui.render.atomGetNeighbors(e).each(function(e){var r=ui.render.atomGetPos(e.aid);if(util.Vec2.dist(n,r)<.1)return;t.push({id:e.aid,v:util.Vec2.diff(r,n)})}),t.sort(function(e,t){return Math.atan2(e.v.y,e.v.x)-Math.atan2(t.v.y,t.v.x)});var r,i=0,s,o=0;for(r=0;r<t.length;r++)s=util.Vec2.angle(t[r].v,t[(r+1)%t.length].v),s<0&&(s+=2*Math.PI),s>o&&(i=r,o=s);var u=new util.Vec2(1,0);if(t.length>0){if(t.length==1){o=-(4*Math.PI/3);var a=ui.render.atomGetNeighbors(e)[0];if(ui.render.atomGetDegree(a.aid)>1){var f=new Array,l=ui.render.atomGetPos(a.aid),c=util.Vec2.diff(n,l),h=Math.atan2(c.y,c.x);ui.render.atomGetNeighbors(a.aid).each(function(e){var t=ui.render.atomGetPos(e.aid);if(e.bid==a.bid||util.Vec2.dist(l,t)<.1)return;var n=util.Vec2.diff(t,l),r=Math.atan2(n.y,n.x)-h;r<0&&(r+=2*Math.PI),f.push(r)}),f.sort(function(e,t){return e-t}),f[0]<=Math.PI*1.01&&f[f.length-1]<=1.01*Math.PI&&(o*=-1)}}s=o/2+Math.atan2(t[i].v.y,t[i].v.x),u=u.rotate(s)}u.add_(n);var p=ui.render.findClosestAtom(u,.1);return p==null?p={label:"C"}:p=p.id,{atom:p,pos:u}},ui.onOffsetChanged=function(e,t){if(t==null)return;var n=new util.Vec2(e.x-t.x,e.y-t.y);ui.client_area.scrollLeft+=n.x,ui.client_area.scrollTop+=n.y},ui.updateSelection=function(e,t){e=e||{};for(var n in rnd.ReStruct.maps)Object.isUndefined(e[n])?ui.selection[n]=[]:ui.selection[n]=e[n];ui.selection.bonds=ui.selection.bonds.filter(function(e){var t=ui.ctab.bonds.get(e);return ui.selection.atoms.indexOf(t.begin)!=-1&&ui.selection.atoms.indexOf(t.end)!=-1}),t||(ui.render.setSelection(ui.selection),ui.render.update()),ui.updateClipboardButtons()},ui.selected=function(){for(var e in rnd.ReStruct.maps)if(!Object.isUndefined(ui.selection[e])&&ui.selection[e].length>0)return!0;return!1},ui.selectedAtom=function(){return!Object.isUndefined(ui.selection.atoms)&&ui.selection.atoms.length>0},ui.selectAll=function(){ui.ctab.isBlank()||(ui.selectMode($("selector").getAttribute("selid")),ui.editor.selectAll())},ui.removeSelected=function(){ui.addUndoAction(ui.Action.fromFragmentDeletion());for(var e in rnd.ReStruct.maps)ui.selection[e]=[];ui.render.update(),ui.updateClipboardButtons()},ui.hideBlurredControls=function(){var e=!1;return["input_label","selector_dropdown_list","bond_dropdown_list","template_dropdown_list","reaction_dropdown_list","rgroup_dropdown_list"].each(function(t){t=$(t),t.visible()&&(t.hide(),e=!0)}),e},ui.onMouseDown_Ketcher=function(e){ui.hideBlurredControls()},ui.onMouseUp_Ketcher=function(e){util.stopEventPropagation(e)},ui.showAtomAttachmentPoints=function(e){$("atom_ap1").checked=((e.selection||0)&1)>0,$("atom_ap2").checked=((e.selection||0)&2)>0,ui.showDialog("atom_attpoints");var t=(new Event.Handler("atom_attpoints_ok","click",undefined,function(){ui.hideDialog("atom_attpoints"),"onOk"in e&&e.onOk(($("atom_ap1").checked?1:0)+($("atom_ap2").checked?2:0)),t.stop()})).start(),n=(new Event.Handler("atom_attpoints_cancel","click",undefined,function(){ui.hideDialog("atom_attpoints"),"onCancel"in e&&e.onCancel(),n.stop()})).start();$("atom_attpoints_ok").focus()},ui.showAtomProperties=function(e){$("atom_properties").atom_id=e,$("atom_label").value=ui.render.atomGetAttr(e,"label"),ui.onChange_AtomLabel.call($("atom_label"));var t=ui.render.atomGetAttr(e,"charge");$("atom_charge").value=t==0?"":t,t=ui.render.atomGetAttr(e,"isotope"),$("atom_isotope").value=t==0?"":t,$("atom_valence").value=ui.render.atomGetAttr(e,"explicitValence")?ui.render.atomGetAttr(e,"valence"):"",$("atom_radical").value=ui.render.atomGetAttr(e,"radical"),$("atom_inversion").value=ui.render.atomGetAttr(e,"invRet"),$("atom_exactchange").value=ui.render.atomGetAttr(e,"exactChangeFlag")?1:0,$("atom_ringcount").value=ui.render.atomGetAttr(e,"ringBondCount"),$("atom_substitution").value=ui.render.atomGetAttr(e,"substitutionCount"),$("atom_unsaturation").value=ui.render.atomGetAttr(e,"unsaturatedAtom"),$("atom_hcount").value=ui.render.atomGetAttr(e,"hCount"),ui.showDialog("atom_properties"),$("atom_label").activate()},ui.applyAtomProperties=function(){ui.hideDialog("atom_properties");var e=$("atom_properties").atom_id;ui.addUndoAction(ui.Action.fromAtomAttrs(e,{label:$("atom_label").value,charge:$("atom_charge").value==""?0:parseInt($("atom_charge").value),isotope:$("atom_isotope").value==""?0:parseInt($("atom_isotope").value),explicitValence:$("atom_valence").value!="",valence:$("atom_valence").value==""?ui.render.atomGetAttr(e,"valence"):parseInt($("atom_valence").value),radical:parseInt($("atom_radical").value),invRet:parseInt($("atom_inversion").value),exactChangeFlag:parseInt($("atom_exactchange").value)?!0:!1,ringBondCount:parseInt($("atom_ringcount").value),substitutionCount:parseInt($("atom_substitution").value),unsaturatedAtom:parseInt($("atom_unsaturation").value),hCount:parseInt($("atom_hcount").value)}),!0),ui.render.update()},ui.onChange_AtomLabel=function(){this.value=this.value.strip().capitalize();var e=chem.Element.getElementByLabel(this.value);e==null&&this.value!="A"&&this.value!="*"&&this.value!="Q"&&this.value!="X"&&this.value!="R"&&(this.value=ui.render.atomGetAttr($("atom_properties").atom_id,"label"),this.value!="A"&&this.value!="*"&&(e=chem.Element.getElementByLabel(this.value))),this.value=="A"||this.value=="*"?$("atom_number").value="any":e?$("atom_number").value=e.toString():$("atom_number").value=""},ui.onChange_AtomCharge=function(){this.value.strip()==""||this.value=="0"?this.value="":this.value.match(/^[+-]?[1-9][0-9]{0,1}$/)||(this.value=ui.render.atomGetAttr($("atom_properties").atom_id,"charge"))},ui.onChange_AtomIsotope=function(){this.value==util.getElementTextContent($("atom_number"))||this.value.strip()==""||this.value=="0"?this.value="":this.value.match(/^[1-9][0-9]{0,2}$/)||(this.value=ui.render.atomGetAttr($("atom_properties").atom_id,"isotope"))},ui.onChange_AtomValence=function(){},ui.showBondProperties=function(e){$("bond_properties").bond_id=e;var t=ui.render.bondGetAttr(e,"type"),n=ui.render.bondGetAttr(e,"stereo");for(var r in ui.bondTypeMap)if(ui.bondTypeMap[r].type==t&&ui.bondTypeMap[r].stereo==n)break;$("bond_type").value=r,$("bond_topology").value=ui.render.bondGetAttr(e,"topology")||0,$("bond_center").value=ui.render.bondGetAttr(e,"reactingCenterStatus")||0,ui.showDialog("bond_properties"),$("bond_type").activate()},ui.applyBondProperties=function(){ui.hideDialog("bond_properties");var e=$("bond_properties").bond_id,t=Object.clone(ui.bondTypeMap[$("bond_type").value]);t.topology=parseInt($("bond_topology").value),t.reactingCenterStatus=parseInt($("bond_center").value),ui.addUndoAction(ui.Action.fromBondAttrs(e,t),!0),ui.render.update()},ui.showSGroupProperties=function(e,t,n,r,i){if(!t)throw new Error("Tool not specified. Note: this method should only be invoked by rnd.Editor.SGroupTool.SGroupHelper, all other usages are obsolete.");if($("sgroup_properties").visible())return;var s=e==null?"GEN":ui.render.sGroupGetType(e);$("sgroup_properties").sgroup_id=e,$("sgroup_type").value=s,ui.onChange_SGroupType.call($("sgroup_type"));switch(s){case"SRU":$("sgroup_connection").value=ui.render.sGroupGetAttr
(e,"connectivity"),$("sgroup_label").value=ui.render.sGroupGetAttr(e,"subscript");break;case"MUL":$("sgroup_label").value=ui.render.sGroupGetAttr(e,"mul");break;case"SUP":$("sgroup_label").value=ui.render.sGroupGetAttr(e,"name");break;case"DAT":$("sgroup_field_name").value=ui.render.sGroupGetAttr(e,"fieldName"),$("sgroup_field_value").value=ui.render.sGroupGetAttr(e,"fieldValue");var o=ui.render.sGroupGetAttr(e,"attached"),u=ui.render.sGroupGetAttr(e,"absolute");(o?$("sgroup_pos_attached"):u?$("sgroup_pos_absolute"):$("sgroup_pos_relative")).checked=!0}s!="DAT"&&($("sgroup_field_name").value="",$("sgroup_field_value").value="");var a=function(){ui.hideDialog("sgroup_properties"),l(),i.call(t)},f=function(){ui.hideDialog("sgroup_properties");var e=$("sgroup_properties").sgroup_id,n=$("sgroup_type").value,i={mul:null,connectivity:"",name:"",subscript:"",fieldName:"",fieldValue:""};switch(n){case"SRU":i.connectivity=$("sgroup_connection").value,i.subscript=$("sgroup_label").value;break;case"MUL":i.mul=parseInt($("sgroup_label").value);break;case"SUP":i.name=$("sgroup_label").value;break;case"DAT":i.fieldName=$("sgroup_field_name").value.strip(),i.fieldValue=$("sgroup_field_value").value.strip(),i.absolute=$("sgroup_pos_absolute").checked,i.attached=$("sgroup_pos_attached").checked;if(i.fieldName==""||i.fieldValue==""){alert("Please, specify data field name and value."),ui.showDialog("sgroup_properties");return}}l(),r.call(t,e,n,i)},l=function(){$("sgroup_prop_cancel").stopObserving("click",a),$("sgroup_prop_ok").stopObserving("click",f)};$("sgroup_prop_cancel").observe("click",a),$("sgroup_prop_ok").observe("click",f),ui.showDialog("sgroup_properties"),ui.sGroupDlgSelection=n,$("sgroup_type").activate()},ui.onChange_SGroupLabel=function(){$("sgroup_type").value=="MUL"&&!this.value.match(/^[1-9][0-9]{0,2}$/)&&(this.value="1")},ui.onChange_SGroupType=function(){var e=$("sgroup_type").value;if(e=="DAT"){$$(".generalSGroup").each(function(e){e.hide()}),$$(".dataSGroup").each(function(e){e.show()}),$("sgroup_field_name").activate();return}$$(".generalSGroup").each(function(e){e.show()}),$$(".dataSGroup").each(function(e){e.hide()}),$("sgroup_label").disabled=e!="SRU"&&e!="MUL"&&e!="SUP",$("sgroup_connection").disabled=e!="SRU";if(e=="MUL"&&!$("sgroup_label").value.match(/^[1-9][0-9]{0,2}$/))$("sgroup_label").value="1";else if(e=="SRU")$("sgroup_label").value="n";else if(e=="GEN"||e=="SUP")$("sgroup_label").value="";e!="GEN"&&$("sgroup_label").activate()},ui.showAutomapProperties=function(e){ui.showDialog("automap_properties");var t=(new Event.Handler("automap_ok","click",undefined,function(){t.stop(),n.stop(),e&&"onOk"in e&&e.onOk($("automap_mode").value),ui.hideDialog("automap_properties")})).start(),n=(new Event.Handler("automap_cancel","click",undefined,function(){t.stop(),n.stop(),ui.hideDialog("automap_properties"),e&&"onCancel"in e&&e.onCancel()})).start();$("automap_mode").activate()},ui.onClick_ElemTableButton=function(){if(this.hasClassName("buttonDisabled"))return;ui.showElemTable()},ui.showElemTable=function(){if($("elem_table").visible())return;ui.showDialog("elem_table"),typeof ui.elem_table_obj=="undefined"&&(ui.elem_table_obj=new rnd.ElementTable("elem_table_area",{fillColor:"#DADADA",fillColorSelected:"#FFFFFF",frameColor:"#E8E8E8",fontSize:23,buttonHalfSize:18},!0),ui.elem_table_area=ui.elem_table_obj.renderTable(),$("elem_table_single").checked=!0),ui.elem_table_obj.store(),$("elem_table_ok").focus()},ui.showRGroupTable=function(e){if(!$("rgroup_table").visible()){e=e||{},ui.showDialog("rgroup_table"),typeof ui.rgroup_table_obj=="undefined"&&(ui.rgroup_table_obj=new rnd.RGroupTable("rgroup_table_area",{fillColor:"#DADADA",fillColorSelected:"#FFFFFF",frameColor:"#E8E8E8",fontSize:18,buttonHalfSize:18},!0)),ui.rgroup_table_obj.setMode(e.mode||"multiple"),ui.rgroup_table_obj.setSelection(e.selection||0);var t=(new Event.Handler("rgroup_table_ok","click",undefined,function(){t.stop(),n.stop(),ui.hideDialog("rgroup_table"),"onOk"in e&&e.onOk(ui.rgroup_table_obj.selection)})).start(),n=(new Event.Handler("rgroup_table_cancel","click",undefined,function(){t.stop(),n.stop(),ui.hideDialog("rgroup_table"),"onCancel"in e&&e.onCancel()})).start();$("rgroup_table_ok").focus()}},ui.showRLogicTable=function(e){e=e||{},e.rlogic=e.rlogic||{},$("rlogic_occurrence").value=e.rlogic.occurrence||">0",$("rlogic_resth").value=e.rlogic.resth||"0",$("rlogic_if").innerHTML='<option value="0">Always</option>';for(var t=1;t<=32;t++)t!=e.rgid&&0!=(e.rgmask&1<<t-1)&&($("rlogic_if").innerHTML+='<option value="'+t+'">IF R'+e.rgid+" THEN R"+t+"</option>");$("rlogic_if").value=e.rlogic.ifthen,ui.showDialog("rlogic_table");var n=(new Event.Handler("rlogic_ok","click",undefined,function(){n.stop(),r.stop(),ui.hideDialog("rlogic_table"),e&&"onOk"in e&&e.onOk({occurrence:$("rlogic_occurrence").value,resth:$("rlogic_resth").value=="1",ifthen:parseInt($("rlogic_if").value)})})).start(),r=(new Event.Handler("rlogic_cancel","click",undefined,function(){n.stop(),r.stop(),ui.hideDialog("rlogic_table"),e&&"onCancel"in e&&e.onCancel()})).start();$("rlogic_occurrence").activate()},ui.onSelect_ElemTableNotList=function(){try{ui.elem_table_obj.updateAtomProps()}catch(e){ErrorHandler.handleError(e)}},ui.clipboard=null,ui.isClipboardEmpty=function(){return ui.clipboard==null},ui.updateClipboardButtons=function(){ui.isClipboardEmpty()?$("paste").addClassName("buttonDisabled"):$("paste").removeClassName("buttonDisabled"),ui.selected()?($("copy").removeClassName("buttonDisabled"),$("cut").removeClassName("buttonDisabled")):($("copy").addClassName("buttonDisabled"),$("cut").addClassName("buttonDisabled"))},ui.copy=function(e,t){e||(e=ui.ctab,t=ui.selection),ui.clipboard={atoms:new Array,bonds:new Array,sgroups:new Array,rxnArrows:new Array,rxnPluses:new Array,chiralFlags:new Array,rgmap:{},rgroups:{},getAnchorPosition:function(){if(this.atoms.length)return this.atoms[0].pp;if(this.rxnArrows.length)return this.rxnArrows[0].pp;if(this.rxnPluses.length)return this.rxnPluses[0].pp;if(this.chiralFlags.length)return this.chiralFlags[0].pp}},ui.structToClipboard(ui.clipboard,e,t)},ui.structToClipboard=function(e,t,n){n=n||{atoms:t.atoms.keys(),bonds:t.bonds.keys(),rxnArrows:t.rxnArrows.keys(),rxnPluses:t.rxnPluses.keys()};var r={};n.atoms.each(function(n){var i=new chem.Struct.Atom(t.atoms.get(n));i.pos=i.pp,r[n]=e.atoms.push(new chem.Struct.Atom(i))-1}),n.bonds.each(function(n){var i=new chem.Struct.Bond(t.bonds.get(n));i.begin=r[i.begin],i.end=r[i.end],e.bonds.push(new chem.Struct.Bond(i))});var i=new Hash;n.atoms.each(function(e){var n=util.Set.list(t.atoms.get(e).sgs);n.each(function(e){var t=i.get(e);Object.isUndefined(t)?t=1:t++,i.set(e,t)},this)},this),i.each(function(n){var i=parseInt(n.key),s=t.sgroups.get(i),o=chem.SGroup.getAtoms(t,s);if(n.value==o.length){var u={type:s.type,attrs:s.getAttrs(),atoms:util.array(o)};for(var a=0;a<u.atoms.length;a++)u.atoms[a]=r[u.atoms[a]];e.sgroups.push(u)}}),n.rxnArrows.each(function(n){var r=new chem.Struct.RxnArrow(t.rxnArrows.get(n));r.pos=r.pp,e.rxnArrows.push(r)}),n.rxnPluses.each(function(n){var r=new chem.Struct.RxnPlus(t.rxnPluses.get(n));r.pos=r.pp,e.rxnPluses.push(r)});var s={},o=util.Set.empty();n.atoms.each(function(e){var n=t.atoms.get(e),r=n.fragment;s[e]=r,util.Set.add(o,r)});var u=util.Set.empty();util.Set.each(o,function(n){var r=chem.Struct.Fragment.getAtoms(t,n);for(var i=0;i<r.length;++i)if(!util.Set.contains(s,r[i]))return;var o=chem.Struct.RGroup.findRGroupByFragment(t.rgroups,n);e.rgmap[n]=o,util.Set.add(u,o)},this),util.Set.each(u,function(n){e.rgroups[n]=t.rgroups.get(n).getAttrs()},this)},ui.onClick_Cut=function(){if(this.hasClassName("buttonDisabled"))return;ui.copy(),ui.removeSelected()},ui.onClick_Copy=function(){if(this.hasClassName("buttonDisabled"))return;ui.copy(),ui.updateSelection()},ui.onClick_Paste=function(){if(this.hasClassName("buttonDisabled"))return;ui.selectMode("paste")},ui.onClick_Undo=function(){if(this.hasClassName("buttonDisabled"))return;ui.undo()},ui.onClick_Redo=function(){if(this.hasClassName("buttonDisabled"))return;ui.redo()},ui.showLabelEditor=function(e){var t=$("input_label"),n=Math.min(6*ui.zoom,16);t.atom_id=e,t.value=ui.render.atomGetAttr(e,"label"),t.style.fontSize=(n*2).toString()+"px",t.show();var r=ui.render.obj2view(ui.render.atomGetPos(e)),i=ui.client_area.cumulativeOffset(),s=Element.cumulativeOffset(t.offsetParent),o=0;t.style.left=(r.x+i.left-s.left-n-o).toString()+"px",t.style.top=(r.y+i.top-s.top-n-o).toString()+"px",t.activate()};