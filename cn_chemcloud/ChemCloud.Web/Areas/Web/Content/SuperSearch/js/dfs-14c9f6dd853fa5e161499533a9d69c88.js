/****************************************************************************
 * Copyright (C) 2009-2010 GGA Software Services LLC
 *
 * This file may be distributed and/or modified under the terms of the
 * GNU Affero General Public License version 3 as published by the Free
 * Software Foundation and appearing in the file LICENSE.GPL included in
 * the packaging of this file.
 *
 * This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE
 * WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.
 ***************************************************************************/
if(!window.chem||!chem.Struct)throw new Error("Molecule should be defined first");chem.Dfs=function(e,t,n,r){this.molecule=e,this.atom_data=t,this.components=n,this.nComponentsInReactants=-1,this.nReactants=r,this.vertices=new Array(this.molecule.atoms.count()),this.molecule.atoms.each(function(e){this.vertices[e]=new chem.Dfs.VertexDesc},this),this.edges=new Array(this.molecule.bonds.count()),this.molecule.bonds.each(function(e){this.edges[e]=new chem.Dfs.EdgeDesc},this),this.v_seq=new Array},chem.Dfs.VertexDesc=function(){this.dfs_state=0,this.parent_vertex=0,this.parent_edge=0,this.branches=0},chem.Dfs.EdgeDesc=function(){this.opening_cycles=0,this.closing_cycle=0},chem.Dfs.SeqElem=function(e,t,n){this.idx=e,this.parent_vertex=t,this.parent_edge=n},chem.Dfs.prototype.walk=function(){var e=new Array,t,n,r=0,i=0;for(;;){if(e.length<1){var s=-1,o=function(e){return this.vertices[e].dfs_state==0?(s=e,!0):!1};while(r<this.components.length&&s==-1)s=util.Set.find(this.components[r],o,this),s===null&&(s=-1,r++,r==this.nReactants&&(this.nComponentsInReactants=i));s<-1&&this.molecule.atoms.find(o,this);if(s==-1)break;this.vertices[s].parent_vertex=-1,this.vertices[s].parent_edge=-1,e.push(s),i++}var u=e.pop(),a=this.vertices[u].parent_vertex,f=new chem.Dfs.SeqElem(u,a,this.vertices[u].parent_edge);this.v_seq.push(f),this.vertices[u].dfs_state=2;var l=this.atom_data[u];for(t=0;t<l.neighbours.length;t++){var c=l.neighbours[t].aid,h=l.neighbours[t].bid;if(c==a)continue;if(this.vertices[c].dfs_state==2){this.edges[h].closing_cycle=1,n=u;while(n!=-1){if(this.vertices[n].parent_vertex==c)break;n=this.vertices[n].parent_vertex}if(n==-1)throw new Error("cycle unwind error");this.edges[this.vertices[n].parent_edge].opening_cycles++,this.vertices[u].branches++,f=new chem.Dfs.SeqElem(c,u,h),this.v_seq.push(f)}else{if(this.vertices[c].dfs_state==1){n=e.indexOf(c);if(n==-1)throw new Error("internal: removing vertex from stack");e.splice(n,1);var p=this.vertices[c].parent_vertex;p>=0&&this.vertices[p].branches--}this.vertices[u].branches++,this.vertices[c].parent_vertex=u,this.vertices[c].parent_edge=h,this.vertices[c].dfs_state=1,e.push(c)}}}},chem.Dfs.prototype.edgeClosingCycle=function(e){return this.edges[e].closing_cycle!=0},chem.Dfs.prototype.numBranches=function(e){return this.vertices[e].branches},chem.Dfs.prototype.numOpeningCycles=function(e){return this.edges[e].opening_cycles},chem.Dfs.prototype.toString=function(){var e="";return this.v_seq.each(function(t){e+=t.idx+" -> "}),e+="*",e};